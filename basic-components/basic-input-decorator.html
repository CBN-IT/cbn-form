<!--
`cbn-basic-input` implements a basic input decorator.

@group cbn-form
@element cbn-basic-input-decorator
-->

<!-- Imports -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../cbn-form-abstract.html">

<polymer-element name="cbn-basic-input-decorator">
	
	<template>
		<link rel="stylesheet" href="basic-input-decorator.css" />
		
		<label id="label" on-tap="{{_tapHandler}}">
			<span>{{label}}</span>
			<content></content>
		</label>
		
		<span class="error {{ { hidden: !invalid } | tokenList }}">{{ _validationError }}</span>
	</template>
	
	<script>
		(function(){
			
			var labelId = 0;
			function generateLabelId() {
				return 'basic-decorator-label-' + (labelId++);
			}
			
			Polymer('cbn-basic-input-decorator', CbnForm.implement({
				
				publish: {
					/**
					 * Input label text to show next to the input.
					 *
					 * @attribute label
					 * @type {String}
					 */
					label: '',
					
					/**
					 * Whether the input is in a preview state.
					 * 
					 * @attribute previewstate
					 * @type {Boolean}
					 */
					previewState: false,
					
					/**
					 * Set this property to true to validate the input as the user types (at the `input` event).
					 * 
					 * @attribute autoValidate
					 * @type Boolean
					 * @default false
					 */
					autoValidate: false,
					
					/**
					 * Whether the decorated input value is invalid.
					 */
					invalid: {
						value: false,
						reflect: true
					}
					
				},
				
				/**
				 * Element's dynamically-configurable attributes.
				 */
				dynamicAttributes: {
					"label" : { type: 'attribute' },
					"autoValidate": { type: 'attribute' }
				},
				
				/**
				 * Specifies the selectors used to search for the inputs.
				 */
				_inputSelector: 'input, textarea, select, [is-form-input]',
				
				/**
				 * Stores reference to the [first] decorated input element.
				 * 
				 * @private
				 * @type {HTMLElement}
				 */
				_inputElement: null,
				
				/**
				 * Stores the validation error. Empty means no error.
				 * @private
				 * @type {String}
				 */
				_validationError: '',
				
				
				/**
				 * Fires when the element is created. Used to initialize its attributes.
				 */
				created: function () {
				},
				
				/**
				 * Fires when the element is ready. Used to initialize event handlers.
				 */
				ready: function () {
					this.addEventListener('input', this._onInput.bind(this));
					this.addEventListener('change', this._onChange.bind(this));
					this.addEventListener('cbn-form-validate', this._onValidate.bind(this));
				},
				
				/**
				 * Called when polymer element has been fully prepared and its DOM children are initialized.
				 * 
				 * Analyzes the light DOM and retrieves the decorated input element.
				 */
				domReady: function() {
					this._inputElement = this.querySelector(this._inputSelector);
					
					var label = this.$.label;
					label.id = generateLabelId();
					
					if (this._inputElement) {
						this._inputElement.setAttribute('aria-labelledby', label.id);
					}
				},
				
				/**
				 * Validates the element.
				 */
				validate: function() {
					this.invalid = false;
					if (!this._inputElement) return true;
					
					this._inputElement.validate();
					// the cbn-form-validate event is synchronous
					return !this.invalid;
				},
				
				// Private methods:
				
				/**
				 * Updates the decorator to reflect the current validation status of the input.
				 */
				_updateValidation: function() {
					this.invalid = !this._inputElement.validationState.valid;
					this._validationError = this._inputElement.validationState.message;
					
					return !this.invalid;
				},
				
				/**
				 * Input `input` event handler.
				 */
				_onInput: function() {
					if (this.autoValidate) {
						this.validate();
					}
				},
				
				/**
				 * Input `input` event handler.
				 */
				_onChange: function() {
					if (this.autoValidate) {
						this.validate();
					}
				},
				
				/**
				 * Called after the decorated input validates.
				 */
				_onValidate: function() {
					this._updateValidation();
				},
				
				/**
				 * Label tap handler to focus the input element.
				 */
				_tapHandler: function() {
					if (this._inputElement) {
						this._inputElement.focus();
					}
				}
				
			}, CbnForm.AbstractInputDecorator, CbnForm.DynamicControl));
			
		})();
		
	</script>
	
</polymer-element>
