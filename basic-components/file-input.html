<!--
`cbn-basic-input` implements a basic text input.

@group cbn-form
@element input-text
-->

<!-- Imports -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../cbn-form-abstract.html">

<polymer-element name="cbn-basic-file" is-form-input is-file-input 
				 attributes="type name label value uploadedFiles">
	
	<template>
		<label>
			<span>{{label}}</span>
			<input id="input" name="{{name}}" on-change="{{fileSelected}}"
				   type="file" multiple?="{{multiple}}"
				   class="{{ { preview: previewstate } | tokenList }}" 
				   title="{{config.label}}" />
		</label>
	</template>
	
	<script>
		
		// JSDoc type defs:
		
		/**
		 * The file model object that describes a selected / already uploaded file.
		 * 
		 * @typedef  {Object}	FileModel
		 * @property {String} 	[name] The name of the selected/uploaded file.
		 * @property {Boolean}	[uploaded] Whether the file is uploaded.
		 * @property {int}		[size] The size of the file, in bytes.
		 * @property {String}	[type] The MIME type of the file (warning: unreliable).
		 * 
		 * For uploaded files that are found in the value before the input is created, the object can contain any 
		 * additional properties which are guaranteed to be preserved.
		 */
		
		// Element definition
		
		Polymer('cbn-basic-file', CbnForm.implement({
			
			publish: { // Published attributes:
				
				/**
				 * It's a file input!
				 */
				isFileInput: true,
				
				/**
				 * Input's name (also the model value path).
				 * @type {String}
				 * @default ''
				 */
				name: '',
				
				/**
				 * Stores the selected files (both previous/uploaded and currently-selected) as an object or array of 
				 * objects (if multiple is true).
				 * 
				 * @type {FileModel | FileModel[]}
				 * @default {} | []
				 */
				value: null,
				
				/**
				 * Whether multiple file uploads are permitted.
				 * 
				 * @attribute multiple
				 * @type {Boolean}
				 */
				multiple: false,
				
				/**
				 * Input label text to show next to the input.
				 * 
				 * @attribute label
				 * @type {String}
				 */
				label: '', 
				
				/**
				 * Whether the input is in a preview state.
				 * 
				 * @attribute previewstate
				 * @type {Boolean}
				 */
				previewState: false
				
			}, 
			
			
			/**
			 * Element's dynamically-configurable attributes.
			 */
			inputAttributes: [ 'name', 'multiple', 'label' ], 
			
			/**
			 * Stores the already-uploaded file(s) (found inside the model before the file input was initialized).
			 * 
			 * If multiple is false, the value will be overridden when a new file will be selected.
			 * If multiple is true, the values will be preserved.
			 * 
			 * @private
			 * @type {FileModel | FileModel[]}
			 * @default {} | []
			 */
			uploadedFiles: null, 
			
			
			/**
			 * Fires when the element is created. Used to initialize its attributes.
			 */
			created: function () {
				if (this.multiple) {
					this.value = [];
					this.uploadedFiles = [];
				} else {
					this.value = {};
					this.uploadedFiles = {};
				}
			},
			
			// Own methods:
			
			/**
			 * Returns the input's FileList object that contains the selected files.
			 * 
			 * @return {FileList} A FileList object that contains the selected files.
			 */
			getFiles: function () {
				return this.$.input.files;
			},
			
			/**
			 * File input changed event, called when a file is selected.
			 * 
			 * Used to update the input's value.
			 */
			fileSelected: function() {
				var i;
				var filesModel = [];
				var files = this.getFiles();
				if (files && files.length) {
					for (i=0; i<files.length; i++) {
						filesModel.push({
							uploaded: false,
							name: files[i].name, 
							size: files[i].size,
							type: files[i].type
						});
					}
				}
				
				if (this.multiple) {
					this.value = filesModel;
				} else {
					if (filesModel.length > 0)
						this.value = filesModel[0];
					else this.value = {};
				}
			}
			
		}, CbnForm.AbstractFileInput));
		
		//noinspection JSCheckFunctionSignatures
		CbnForm.registerElement('cbn-basic-file', {
				types: ['file']
			});
		
	</script>
	
</polymer-element>
