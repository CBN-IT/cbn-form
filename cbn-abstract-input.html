<!--
`cbn-abstract-input` defines the common interfaces that all embeddable cbn-form input elements must implement.

Each input element must implement CbnAbstractInputMixin's abstract methods, have a declared `is-form-input` HTML 
attribute and register its input type[s] via the {@link CbnFormInputs#registerType} (used for dynamic form input 
type discovery).

Several special element attributes are supported: 'class' (can be an Array of Strings or a String) and 'style' (which 
can be a CSS String or an object with CSS properties to set).

@group cbn-form
@element cbn-abstract-input
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">

<polymer-element name="cbn-abstract-input" attributes="config preview">
	
	<template>
		<!-- The local DOM will be filled dynamically by {@link #ready} -->
	</template>
	
	<script>
		
		/**
		 * Class used by the inputs to register their capabilities with the `cbn-form` library.
		 */
		var CbnFormInputs = {
			
			/**
			 * Stores the registered inputs by type.
			 * The key is the input type and the value is the element's name.
			 * 
			 * @private
			 * @type { Object.<String, String> }
			 */
			_registeredTypes: {},
			
			/**
			 * Stores the registered elements as a Boolean map.
			 * 
			 * @private
			 * @type { Object.<String, Boolean> }
			 */
			_registeredElements: {},
			
			/**
			 * Registers a new input element to be usable within `cbn-form`.
			 * 
			 * @param {String} typeName The input `type` (e.g. text / number / date) provided by the element.
			 * @param {String} element The name of the custom input element.
			 */
			registerType: function (typeName, element) {
				if (this._registeredTypes[typeName] != undefined)
					return false;
				
				this._registeredTypes[typeName] = element;
				this._registeredElements[element] = true;
				
				return true;
			}
			
		};
		
		
		/**
		 * Defines the abstract interface to be implemented by the custom input elements.
		 * 
		 * Note: you need to insert this mixin before your actual component definition in order to override the
		 * settings here!
		 * 
		 * Example:
		 *     Polymer('your-element', Polymer.mixin({}, CbnAbstractInputMixin, {
		 *         // element's properties
		 *     }));
		 */
		var CbnAbstractInputMixin = {
			
			// Attributes and properties:
			
			/**
			 * All `cbn-form`-embeddable inputs must have this set as a HTML attribute (which can be used as selector 
			 * to query the inputs).
			 * 
			 * @attribute is-form-input
			 * @type {Boolean}
			 */
			isFormInput: true,
			
			/**
			 * This should be true for `"type"="file"` fields (which need special handling inside form's submit method).
			 * 
			 * All file inputs must also expose a {@link #getFiles} method that returns a FileList-compatible interface 
			 * to the selected files.
			 * 
			 * @type {Boolean}
			 */
			isFileInput: false,
			
			/**
			 * Input's name. 
			 * 
			 * It is used as model binding path 
			 * For example, the value 'name.first_name' will bind to the model path `model.name.first_name`.
			 * 
			 * @attribute name
			 * @type {String}
			 */
			name: '',
			
			/**
			 * Input's value attribute.
			 * Should be String for most of the cases, Array if the input supports multiple values and Object for
			 * special input types (e.g. file). And array of objects for special types with multiple values, ofc. ;)
			 * 
			 * @attribute value
			 * @type { Array | Object | [String] | [Object]}
			 */
			value: null,
			
			/**
			 * Whether the current instance should be shown as preview in form groups.
			 * 
			 * @attribute preview
			 * @type {Boolean}
			 */
			preview: false,
			
			/**
			 * Is the input currently in a preview state?
			 * 
			 * Automatically bound by the `cbn-form-group` component if the {@link #preview} property is true.
			 * 
			 * @attribute previewstate
			 * @type {Boolean}
			 */
			previewstate: false,
			
			/**
			 * Defines input element's dynamically-configurable attributes. Again, should be just a DOM property.
			 * 
			 * Note that 'value' and 'previewstate' are automatically-bound attributes and don't need to be enumerated 
			 * here.
			 * 
			 * @type {[String]}
			 */
			inputAttributes: [ "type", "name", "preview" ],
			
			/**
			 * Stores the parent `cbn-form` element. DOM property.
			 * 
			 * @type {HTMLElement}
			 */
			parentForm: null,
			
			
			// Element lifecycle methods:
			
			/**
			 * Element instance created callback.
			 * 
			 * Use `CbnAbstractInputMixin.created.apply(this)` if you want to override it.
			 */
			created: function () {
				// nothing yet
			}, 
			
			/**
			 * Polymer element ready callback.
			 * 
			 * Use `CbnAbstractInputMixin.ready.apply(this)` if you want to override it.
			 */
			ready: function () {
				this.setAttribute('is-form-input', true);
				
				if (this.isFileInput)
					this.setAttribute('is-file-input', this.isFileInput);
				else this.removeAttribute('is-file-input');
			},
			
			/**
			 * Sends an event to notify the parent containers of this input's existence in their DOM.
			 * 
			 * Use `CbnAbstractInputMixin.attached.apply(this)` if you want to override it.
			 */
			attached: function () {
				var input = this;
				this.async(function(){
					this.fire('cbn-form-input-attached', {
						input: input, 
						bindValue: true
					}, null, true, false);
				});
			},
			
			/**
			 * Sends an event to notify the parent containers of this input's detachment from their DOM.
			 * 
			 * Use `CbnAbstractInputMixin.detached.apply(this)` if you want to override it.
			 */
			detached: function () {
				var input = this;
				this.fire('cbn-form-input-detached', {
					input: input, 
					unbindValue: true
				}, null, true, false);
			},
			
			// Fired events:
			
			/**
			 * Fired automatically when an input attaches. 
			 * Bubbles up the DOM tree.
			 * 
			 * @event cbn-form-input-attached
			 */
			
			/**
			 * Fired automatically when an input is detached from DOM. 
			 * Bubbles up the DOM tree.
			 * 
			 * @event cbn-form-input-detached
			 */
			
			
			// Element methods: 
			
			/**
			 * Requests validation of the input (called by the form element before submit).
			 * 
			 * The input element is responsible for showing / highlighting the error to the user.
			 * 
			 * @return True if the input validates, false otherwise.
			 */
			validate: function () {
				return true;
			}, 
			
			/**
			 * This method should be implemented by file inputs.
			 * Used by the primary form component to send the uploaded files via AJAX.
			 * 
			 * @return {FileList} A FileList (preferably) object that contains the selected files.
			 */
			getFiles: function () {
				throw "Not implemented!";
			}
			
		};
		
		/**
		 * The abstract input element is a proxy Polymer element that automatically loads a registered input by its
		 * type.
		 */
		Polymer('cbn-abstract-input', {
			
			/**
			 * The input field's configuration object.
			 * 
			 * @typedef  {Object}	FormFieldConfig
			 * @property {String} 	type 	The element's type (used to instantiate the element based on type).
			 * @property {String} 	element	The name of the element to instantiate (forced, overrides the type). Optional.
			 * @property {String}	name	The input name / model value's path (that describes where in the model the 
			 * 								data should be read / written).
			 * @property {String}	preview	Whether the element is visible in a preview-state form group.
			 * 
			 * All other properties are directly passed as attributes to the instantiated element only if they were 
			 * specified inside the {@link CbnAbstractInputMixin#inputAttributes} array.
			 */
			
			/**
			 * The form input configuration object. Should contain at least the 'type' (or 'element') and 'name' 
			 * properties.
			 * 
			 * @attribute config
			 * @type FormFieldConfig
			 * @default {}
			 */
			config: null,
			
			/**
			 * The HTML element of the created input.
			 * 
			 * @type {HTMLElement}
			 * @default null
			 */
			element: null,
			
			/**
			 * Fires when the element is created. Used to initialize its attributes.
			 */
			created: function () {
				this.config = {};
				this.model = {};
			},
			
			/**
			 * Called when polymer element has been fully prepared.
			 * 
			 * Creates the actual input element based on the given `type` or `element` parameter.
			 */
			ready: function () {
				var elementName;
				if (this.config.element) {
					elementName = this.config.element;
				} else {
					elementName = CbnFormInputs._registeredTypes[this.config.type];
					if (!elementName) {
						console.error("Polymer(\"cbn-abstract-input\"): input type not registered ('" +
						this.config.type + "')");
						return false;
					}
				}
				this.element = document.createElement(elementName);
				if (!this.element || !this.element.isFormInput || !this.element.inputAttributes) {
					console.error("Polymer(\"cbn-abstract-input\"): invalid input element ('" +
					elementName + "')");
					return false;
				}
				
				// set element attributes
				for (var c in this.config) {
					if (!this.config.hasOwnProperty(c)) 
						continue;
					
					if (c == 'style') {
						if (typeof this.config[c] == 'object') {
							for (var s in this.config[c]) {
								if (this.config[c].hasOwnProperty(s))
									this.element.style[s] = this.config[c][s];
							}
							
						} else {
							this.element.style.cssText = this.config[c];
						}
						
					} else if (c == 'class') {
						if (typeof this.config[c] == 'object' && this.config[c].length) {
							this.element.className = this.config[c].join(' ');
						} else {
							this.element.className = this.config[c].toString();
						}
						
					} else if (this.element.inputAttributes.indexOf(c) >= 0) {
						this.element[c] = this.config[c];
					}
				}
				
				// append the element to the local DOM
				this.shadowRoot.appendChild(this.element);
			}
			
		});
	</script>
	
</polymer-element>
