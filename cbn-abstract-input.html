<!--
`cbn-abstract-input` describes the common interfaces that all embeddable cbn-form input elements must implement.

Each input element must implement CbnAbstractInputMixin's abstract methods, have a declared `is-form-input` HTML 
attribute and register its input type[s] via the {@link CbnFormInputs#registerType} (used for dynamic form input 
type discovery).

@group cbn-form
@element cbn-abstract-input
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">

<polymer-element name="cbn-abstract-input" attributes="config preview">
	
	<template>
		<!-- The local DOM will be filled dynamically by {@link #ready} -->
	</template>
	
	<script>
		
		/**
		 * Class used by the inputs to register their capabilities with the `cbn-form` library.
		 */
		var CbnFormInputs = {
			
			_registeredTypes: {},
			
			/**
			 * Registers a new input element to be usable within `cbn-form`.
			 *
			 * @param {String} typeName The input `type` (e.g. text / number / date) provided by the element.
			 * @param {String} element The name of the custom input element.
			 */
			registerType: function (typeName, element) {
				if (this._registeredTypes[typeName] != undefined)
					return false;
				
				this._registeredTypes[typeName] = element;
				return true;
			}
			
		};
		
		
		/**
		 * Defines the abstract interface to be implemented by the custom input elements.
		 *
		 * Note: you need to insert this mixin before your actual component definition in order to override the
		 * settings here!
		 *
		 * Example:
		 *     Polymer('your-element', Polymer.mixin({}, CbnAbstractInputMixin, {
		 *         // element's properties
		 *     }));
		 */
		var CbnAbstractInputMixin = {
			
			/**
			 * All `cbn-form`-embeddable inputs must have this set as a HTML attribute (used as selector by the parent
			 * form element to search for inputs).
			 *
			 * @attribute is-form-input
			 * @type {Boolean}
			 */
			isFormInput: true,
			
			/**
			 * This should be true for `"type"="file"` fields (which need special handling inside form's submit method).
			 *
			 * All file inputs must also expose a `getFiles()` method that returns a FileList-compatible interface to the
			 * selected files.
			 *
			 * @type {Boolean}
			 */
			isFileInput: false,
			
			/**
			 * Defines input element's dynamically-configurable attributes. Again, should be just a DOM property.
			 *
			 * @type {[String]}
			 */
			inputAttributes: ["type", "name"],
			
			/**
			 * Input's value attribute.
			 * Should be String for most of the cases, Array if the input supports multiple values and Object for
			 * special input types (e.g. file). And array of objects for special types with multiple values, ofc. ;)
			 *
			 * @attribute value
			 * @type { Array | Object | [String] | [Object]}
			 */
			value: null,
			
			/**
			 * Stores the parent `cbn-form` element.
			 */
			parentForm: null,
			
			/**
			 * Requests validation of the input (called by the form element before submit).
			 *
			 * The input is responsible for showing / highlighting the error to the user.
			 *
			 * @return True if the input validates, false otherwise.
			 */
			validate: function () {
				return true;
			},
			
			/**
			 * Polymer element ready callback.
			 *
			 * Use `CbnAbstractInputMixin.ready.apply(this)` if you want to override it.
			 */
			ready: function () {
				this.setAttribute('is-form-input', true);

				if (this.isFileInput)
					this.setAttribute('is-file-input', this.isFileInput);
				else this.removeAttribute('is-file-input');
			},
			
			
			/**
			 * Sends an event to notify the parent containers of this input's existence in their DOM.
			 * 
			 * Use `CbnAbstractInputMixin.attached.apply(this)` if you want to override it.
			 */
			attached: function () {
				this.async(function(){
					this.fire('cbn-form-input-attached', {}, null, true, false);
				});
			},
			
			/**
			 * Sends an event to notify the parent containers of this input's detachment from their DOM.
			 * 
			 * Use `CbnAbstractInputMixin.detached.apply(this)` if you want to override it.
			 */
			detached: function () {
				this.fire('cbn-form-input-detached', {}, null, true, false);
			}
			
			/**
			 * Fired automatically when an input attaches. 
			 * Bubbles up the DOM tree.
			 * 
			 * @event cbn-form-input-attached
			 */
			
			/**
			 * Fired automatically when an input is detached from DOM. 
			 * Bubbles up the DOM tree.
			 * 
			 * @event cbn-form-input-detached
			 */
			
		};

		/**
		 * The abstract input element is a proxy Polymer element that automatically loads a registered input by its
		 * type.
		 */
		Polymer('cbn-abstract-input', {

			/**
			 * The input field's configuration object.
			 * @typedef {Object}    FormFieldConfig
			 */
			
			/**
			 * The form configuration object that contains the model definition, the inputs to be rendered and
			 * their properties.
			 *
			 * @attribute config
			 * @type FormFieldConfig
			 * @default {}
			 */
			config: null,
			
			/**
			 * The HTML element of the created input.
			 *
			 * @type HTMLElement
			 * @default null
			 */
			element: null,
			
			/**
			 * Fires when the element is created. Used to initialize its attributes.
			 */
			created: function () {
				this.config = {};
				this.model = {};
			},
			
			/**
			 * Called when polymer element has been fully prepared.
			 *
			 * Creates the actual input element based on the given `type` or `element` parameter.
			 */
			ready: function () {
				var i;
				
				var elementName;
				if (this.config.element) {
					elementName = this.config.element;
				} else {
					elementName = CbnFormInputs._registeredTypes[this.config.type];
					if (!elementName) {
						console.error("Polymer(\"cbn-abstract-input\"): input type not registered ('" +
						this.config.type + "')");
						return false;
					}
				}
				this.element = document.createElement(elementName);
				if (!this.element || !this.element.isFormInput || !this.element.inputAttributes) {
					console.error("Polymer(\"cbn-abstract-input\"): invalid input element ('" +
					elementName + "')");
					return false;
				}

				// set element attributes
				for (i = 0; i < this.element.inputAttributes.length; i++) {
					var c = this.element.inputAttributes[i];
					if (this.config.hasOwnProperty(c)) {
						this.element[c] = this.config[c];
					}
				}
				
				// append the element to the local DOM
				this.shadowRoot.appendChild(this.element);
			}
			
		});
	</script>
	
</polymer-element>
