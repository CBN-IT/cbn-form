<!--
`cbn-dynamic-form` is an extensible dynamic form component that renders dynamic form fields (via an user-supplied 
configuration object).

Example:
```
    <cbn-form url="/do/something/save" method="post">
    	<cbn-dynamic-form config="{{formInputs}}"></cbn-dynamic-form>
    	<button is="cbn-form-button" type="submit"></button>
    </cbn-form>
```

Where `config` is a custom object that describes the form's layout and the input fields to be dynamically generated.

Example config JSON definition: 
```
	{
		"types": {
			"group": "cbn-form-group", 
			"text": "cbn-basic-input", 
		},
		"defaults": {
			"*": { "inherit": "input" }, 
			"input": {
				"decorator": "cbn-input-decorator",
				"preview": true
			}
		},
		"elements": [{
			"type": "group", 
			"caption": "Main Form", 
			
			"children": [
				{
					"inherit": "input", 
					"name": "name",
					"label": "Name: ", 
					"type": "text", 
					"element": "cbn-basic-input", 
					"preview": true
				}, 
				{
					"inherit": "input", 
					"name": "type",
					"label": "Type: ", 
					"type": "select",
					"options": { "1": "Person", "2": "Company" }
				}
			]
		}]
	}
```

@group cbn-form
@element cbn-dynamic-form
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="cbn-form-abstract.html">
<link rel="import" href="cbn-form-group.html">

<polymer-element name="cbn-dynamic-form">
	<template>
		<!-- An empty shadow root to add the generated elements -->
	</template>
	
	<script>
		(function() {
			//noinspection JSUnusedGlobalSymbols
			Polymer('cbn-dynamic-form', CbnForm.implement({
				
				publish: { // Publish attributes:
					
					/**
					 * The form configuration object that contains the inputs to be rendered, their layout and their properties.
					 * 
					 * @attribute config
					 * @type {FormConfig}
					 * @default {}
					 */
					config: null
					
				},
				
				// Fired events:
				
				/**
				 * Fired when the dynamic form has finished rendering its inputs.
				 * @event cbn-dynamic-form-rendered
				 */
				
				/**
				 * Whether the element is ready.
				 * @private
				 * @type {Boolean}
				 */
				_elementReady: false,
				
				/**
				 * Fires when the element is created. Used to initialize its attributes.
				 */
				created: function () {
					if (!this.config)
						this.config = {};
				},
				
				/**
				 * Called when polymer element has been fully prepared.
				 *
				 * Listens for input attached / detached events and initializes them.
				 */
				ready: function () {
					this._elementReady = true;
					this.configChanged();
				},
				
				/**
				 * Called when the config property is changed.
				 * Used to infer defaults to the form fields' configuration objects.
				 */
				configChanged: function () {
					var config = this.config;
					if (!config || !this._elementReady) return;
					
					var target = this.shadowRoot;
					while (target.firstChild) {
						target.removeChild(target.firstChild);
					}
					this._renderForm(this._extendConfig(config.elements), target);
					
					this.async(function(){
						this.fire('cbn-dynamic-form-rendered', {
							element: this, 
							config: config
						}, null, true, false);
					});
				},
				
				/**
				 * The main routine that renders the dynamic form elements based on the value of the config JSON object.
				 * 
				 * @private
				 * @param {FormElementConfig[]}  elementsConfig The dynamic template to use for rendering the form.
				 * @param {HTMLElement}          root The root element to append the rendered elements to.
				 */
				_renderForm: function(elementsConfig, root) {
					var i;
					if (!elementsConfig) return;
					
					for (i=0; i<elementsConfig.length; i++) {
						var elements = this._createFormElement(elementsConfig[i]);
						if (!elements || !elements.element) continue;
						
						if (elements.decorator) {
							root.appendChild(elements.decorator);
						} else {
							root.appendChild(elements.element);
						}
						if (elementsConfig[i].children) {
							var containerElement = elements.element;
							if (elementsConfig[i].wrapChildren) {
								var wrapper = this._createChildrenWrapper(elementsConfig[i].wrapChildren);
								if (wrapper) {
									containerElement = wrapper;
									elements.element.appendChild(wrapper);
								}
							}
							
							this._renderForm(elementsConfig[i].children, containerElement);
						}
					}
				}, 
				
				/**
				 * Creates a form elements using the specified configuration (template) object.
				 * 
				 * @private
				 * @param {FormElementConfig|Object} elConfig The template object to generate the element from.
				 * @return {Boolean | {element: HTMLElement, decorator: HTMLElement}} The generated element + decorator (if any).
				 */
				_createFormElement: function(elConfig) {
					var elements = { element: null, decorator: null };
					
					var elementName;
					if (elConfig.element) {
						elementName = elConfig.element;
					} else {
						elementName = CbnForm.getElementForType(elConfig.type, this.config.types);
						if (!elementName) {
							console.error("<cbn-dynamic-form>: no element registered for type '" + elConfig.type + "'");
							return false;
						}
					}
					
					var elementDef = CbnForm.getRegisteredElement(elementName);
					if (elementDef) {
						if (elementDef.extends) {
							elements.element = document.createElement(elementDef.extends, elementName);
						} else {
							elements.element = document.createElement(elementName);
						}
					}
					
					if (!elementDef || !elements.element || !CbnForm.implements(elements.element, CbnForm.DynamicControl)) {
						console.error("<cbn-dynamic-form>: invalid form element ('" + elementName + "')");
						return false;
					}
					
					// create the decorator element
					var root = elements.element;
					elements.decorator = null;
					if (elConfig.decorator) {
						elements.decorator = document.createElement(elConfig.decorator);
						if (!elements.decorator || !CbnForm.implements(elements.decorator, CbnForm.AbstractInputDecorator) || 
								!CbnForm.implements(elements.decorator, CbnForm.DynamicControl)) {
							console.error("<cbn-dynamic-form>: invalid decorator element ('" + elConfig.decorator + "')");
							return false;
						}
						root = elements.decorator;
						
						// set the element's display to 'block'
						elements.element.style.display = 'block';
						
						// set decorator default config attributes (from the element's 'decoratorConfig' property)
						if (elements.element.decoratorConfig) {
							for (var dc in elements.element.decoratorConfig) {
								if (!elements.element.decoratorConfig.hasOwnProperty(dc)) 
									continue;
								
								elements.decorator.setDynamicAttribute(dc, elements.element.decoratorConfig[dc]);
							}
						}
					}
					
					// set element attributes
					for (var c in elConfig) {
						if (!elConfig.hasOwnProperty(c)) 
							continue;
						
						if (c == 'style' || c == 'className' || c == 'preview') {
							// always apply to the root element
							root.setDynamicAttribute(c, elConfig[c]);
							
						} else {
							if (elements.decorator && elements.decorator.getDynamicAttributeDescriptor(c)) {
								elements.decorator.setDynamicAttribute(c, elConfig[c]);
							}
							if (elements.element.getDynamicAttributeDescriptor(c)) {
								elements.element.setDynamicAttribute(c, elConfig[c]);
							}
						}
					}
					
					elements.element.sourceTemplate = elConfig;
					
					if (elements.decorator) {
						elements.decorator.sourceTemplate = elConfig;
						elements.decorator.appendChild(elements.element);
					}
					return elements;
				}, 
				
				/**
				 * Creates a basic HTML wrapper element using the specified configuration (template) object.
				 * 
				 * @private
				 * @param {Object}  elConfig The template object (a basic key-value map representing the element attributes).
				 * @return {Boolean | HTMLElement} The generated DOM element.
				 */
				_createChildrenWrapper: function(elConfig) {
					var wrapper = document.createElement(elConfig.element);
					if (!wrapper) return false;
					
					CbnForm.implement(wrapper, CbnForm.DynamicControl);
					for (var c in elConfig) {
						if (!elConfig.hasOwnProperty(c)) 
							continue;
						
						if (c == 'element') {
							// ignore
						} else {
							wrapper.setDynamicAttribute(c, elConfig[c]);
						}
					}
					
					return wrapper;
				}, 
				
				
				// Private functions: 
				
				/**
				 * Pre-processes and extends the specified configuration/template object based on its inherit property 
				 * and the {@link FormConfig#defaults} object.
				 * 
				 * @param {FormElementConfig[]} elements The template objects to extend.
				 * @return {FormElementConfig[]} The resulting config objects list, extended with the defaults.
				 */
				_extendConfig: function(elements) {
					if (!elements)
						return elements;
					
					var extendedConfig = [];
					for (var i=0; i<elements.length; i++) {
						var exConfig = elements[i];
						if (this.config.defaults && this.config.defaults['*']) {
							exConfig = this._extendObject({}, exConfig, this.config.defaults['*']);
						}
						if (exConfig.inherit && this.config.defaults.hasOwnProperty(exConfig.inherit)) {
							exConfig = this._extendObject({}, exConfig, this.config.defaults[exConfig.inherit]);
							delete exConfig.inherit;
						}
						if (exConfig.children && exConfig.children.length) {
							exConfig.children = this._extendConfig(exConfig.children);
						}
						extendedConfig.push(exConfig);
					}
					return extendedConfig;
				}, 
				
				/**
				 * Lightweight object extend function (jQuery-like, right to left processing order).
				 * First argument is the destination object.
				 * @private
				 * @returns {Object} The extended object.
				 */
				_extendObject: function() {
					for (var i = arguments.length - 1; i >= 1; i--) {
						for (var key in arguments[i])
							if (arguments[i].hasOwnProperty(key))
								arguments[0][key] = arguments[i][key];
					}
					return arguments[0];
				}
				
			}, CbnForm.AbstractContainer));
		})();
	</script>
	
</polymer-element>
