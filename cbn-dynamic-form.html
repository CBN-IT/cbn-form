<!--
`cbn-dynamic-form` is an extensible dynamic form component that renders dynamic form fields (via an user-supplied 
configuration object).

Example:
```
    <cbn-form url="/do/something/save" method="post">
    	<cbn-dynamic-form config="{{formInputs}}"></cbn-dynamic-form>
    	<button is="cbn-form-button" type="submit"></button>
    </cbn-form>
```

Where `config` is a custom object that describes the form's layout and the input fields to be dynamically generated.

Example config JSON definition: 
```
	{
		"fieldDefaults": {
			"preview": true, 
			"decorator": "cbn-basic-decorator"
		},
		"groups": [{
			"caption": "Main Form", 
			"fields": [
				{
					"name": "name",
					"label": "Name: ", 
					"type": "text", 
					"element": "cbn-basic-input", 
					"preview": true
				}, 
				{
					"name": "type",
					"label": "Type: ", 
					"type": "select",
					"options": { "1": "Person", "2": "Company" }
				}
			]
		}]
	}
```

@group cbn-form
@element cbn-dynamic-form
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="cbn-form-group.html">
<link rel="import" href="cbn-dynamic-input.html">

<polymer-element name="cbn-dynamic-form" attributes="config model">
	<template>
		<link rel="stylesheet" href="../flexboxgrid/dist/flexboxgrid.min.css">
		
		<template if="{{ config.flatFields }}">
			<!-- Print flat fields -->
			<div class="{{ { 'flat-fields': true, 'row': config.flatFlexGrid } | tokenList }}">
				<template repeat="{{field in config.fields}}">
					<cbn-dynamic-input config="[[field]]"></cbn-dynamic-input>
				</template>
			</div>
		</template>
		
		<template if="{{ config.groups }}">
			<!-- Print groups / their fields -->
			<div id="groups">
				<template repeat="{{group in config.groups}}">
					
					<cbn-form-group caption="[[group.caption]]" toggleable="[[group.toggleable]]"
									class="[[group.className | toClassList]]"
									style="[[group.style | styleObject]]">
						<div class="{{ { 'group-inner': true, 'row': group.flexGrid } | tokenList }}">
							<template repeat="{{field in group.fields}}">
								<cbn-dynamic-input config="[[field]]"></cbn-dynamic-input>
							</template>
						</div>
					</cbn-form-group>
					
				</template>
			</div>
		</template>
		
	</template>
	
	<script>
		Polymer('cbn-dynamic-form', {
			
			/**
			 * The form configuration object that contains the inputs to be rendered, their layout and their properties.
			 * 
			 * @type {FormConfig}
			 * @default {}
			 */
			config: null,
			
			/**
			 * Dynamic form's data model to use for its inputs. If not set, the parent form will manage the fields.
			 * 
			 * @attribute model
			 * @type {Object}
			 * @default null
			 */
			model: null,
			
			/**
			 * Stores the element's parent `cbn-form`.
			 * 
			 * @type {HTMLElement}
			 */
			parentForm: null,
			
			/**
			 * Fires when the element is created. Used to initialize its attributes.
			 */
			created: function() {
				if (!this.config) 
					this.config = {};
			}, 
			
			/**
			 * Called when polymer element has been fully prepared.
			 * 
			 * Listens for input attached / detached events and initializes them.
			 */
			ready: function() {
				var form = this;
				this.configChanged();
				
				if (this.model) {
					this.addEventListener('cbn-form-input-attached', function (event) {
						var input = event.detail.input;
						if (event.detail.bindValue) {
							this.bindValue(input);
							event.detail.bindValue = false; // first-come, first-served
						}
					});
					
					this.addEventListener('cbn-form-input-detached', function (event) {
						var input = event.detail.input;
						if (event.detail.unbindValue) {
							this.unbindValue(input);
							event.detail.unbindValue = false;
						}
					});
				}
			},
			
			/**
			 * Called when the config property is changed.
			 * Used to infer defaults to the form fields' configuration objects.
			 */
			configChanged: function() {
				var config = this.config;
				if (!config)
					return;
				
				if (config.fieldDefaults) {
					// lightweight object extend function (right to left processing order)
					// first argument is the destination object
					function extendObject() {
						for (var i=arguments.length - 1; i >= 1; i--) {
							for (var key in arguments[i]) 
								if (arguments[i].hasOwnProperty(key))
									arguments[0][key] = arguments[i][key];
						}
						return arguments[0];
					}
					// utility function to extend a list of objects with some defaults 
					function extendObjectsList(list, defaults) {
						for (var k=0; k<list.length; k++) {
							if (!list.hasOwnProperty(k)) continue;
							list[k] = extendObject({}, list[k], defaults);
						}
					}
					
					if (config.groups) 
						for (var i=0; i<config.groups.length; i++) {
							extendObjectsList(config.groups[i].fields, config.fieldDefaults);
						}
					if (config.flatFields) {
						extendObjectsList(config.flatFields, config.fieldDefaults);
					}
				}
			}, 
			
			/**
			 * Converts an array of strings to HTML space-separated classes list.
			 * 
			 * @private
			 * @param {String|String[]} classes The input.
			 * @return {String} The resulting HTML classes list.
			 */
			toClassList: function(classes) {
				if (!classes || typeof classes == 'string')
					return classes;
				return classes.join(' ');
			},
			
			/**
			 * Converts a style object to its string representation. Ignores CSS as string (returns it).
			 * 
			 * @private
			 * @param {Object|String} value The object to convert.
			 * @returns {String} The resulting CSS text.
			 */
			styleObject: function(value) {
				if (!value)
					return '';
				if (typeof value == 'string')
					return value;
				
				function convertStylePropertyName(name) {
					return String(name).replace(/[A-Z]/g, function(c) {
						return '-' + c.toLowerCase();
					});
				}
				
				var parts = [];
				for (var key in value) {
					if (value.hasOwnProperty(key))
						parts.push(convertStylePropertyName(key) + ': ' + value[key]);
				}
				return parts.join('; ');
			}
			
		});
	</script>
	
</polymer-element>
