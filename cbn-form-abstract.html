<!--
This file defines the common utilities and interfaces necessary by some components.

Each input element must implement CbnAbstractInputMixin's abstract methods, have a declared `is-form-input` HTML 
attribute and register its input type[s] via the {@link CbnFormInputs#registerElement} (used for dynamic form input 
type discovery).
-->

<script>
	
	// JSDoc types
	
	/**
	 * The form configuration object.
	 * @typedef  {Object} 	FormGroupConfig
	 * @property {String} 	caption Group's caption / title (optional).
	 * @property {Boolean}	toggleable Whether the group is toggleable.
	 * @property {[Object]}	fields Form's fields to be rendered.
	 */
	
	/**
	 * The form configuration object.
	 * @typedef {Object} 				FormConfig
	 * @property {Object}				fieldDefaults Default configuration object, applied to all fields.
	 * @property {[FormGroupConfig]} 	groups The grouped form fields.
	 * @property {[Object]} 			flatFields Flat form fields to render.
	 */
	
	/**
	 * The input field's configuration object.
	 * 
	 * @typedef  {Object}	FormFieldConfig
	 * @property {String} 	type 	The element's type (used to instantiate the element based on type).
	 * @property {String} 	element	The name of the element to instantiate (forced, overrides the type). Optional.
	 * @property {String}	name	The input name / model value's path (that describes where in the model the 
	 * 								data should be read / written).
	 * @property {String}	preview	Whether the element is visible in a preview-state form group.
	 * 
	 * All other properties are directly passed as attributes to the instantiated element only if they were 
	 * specified inside the {@link CbnAbstractInputMixin#inputAttributes} array.
	 */
	
	
	/**
	 * Class used by the inputs to register their capabilities with the `cbn-form` library.
	 */
	var CbnFormInputs = {
		
		/**
		 * Stores the registered inputs by type.
		 * The key is the input type and the value is the element's name.
		 * 
		 * @private
		 * @type { Object.<String, String> }
		 */
		_registeredTypes: {},
		
		/**
		 * Stores the registered elements as a Boolean map.
		 * 
		 * @private
		 * @type { Object.<String, Boolean> }
		 */
		_registeredElements: {},
		
		
		/**
		 * @typedef {Object}    RegisterElementOptions
		 * @property {String[]} types The input types handled by the element.
		 * @property {String}   extended If the element extends another one, set this to the extended element 
		 *                          (e.g.: 'input')
		 */
		
		/**
		 * Registers a new input element to be usable within `cbn-form`.
		 * 
		 * @param {String} name The name of the custom input element.
		 * @param {RegisterElementOptions} options Element's definition object.
		 */
		registerElement: function (name, options) {
			if (this._registeredElements[name] != undefined) {
				console.error("\"cbn-form-abstract.html\": element '" + name + "' is already registered");
				return false;
			}
			
			if (options.types && options.types.length) {
				for (var i=0; i<options.types.length; i++) {
					this._registeredTypes[options.types[i]] = name;
				}
			}
			
			this._registeredElements[name] = options;
			
			return true;
		}, 
		
		/**
		 * Returns a registered element's definition object.
		 * 
		 * @name {String} name The element's name.
		 * @return {RegisterElementOptions} Element's registration options.
		 */
		getElement: function(name) {
			return this._registeredElements[name];
		}, 
		
		/**
		 * Returns the name of an element that was last registered for the requested type.
		 * 
		 * @name {String} type The input type.
		 * @return {String} The element's name.
		 */
		getElementForType: function(type) {
			return this._registeredTypes[type];
		}
		
	};
	
	
	/**
	 * Defines the abstract interface to be implemented by the custom input elements.
	 * 
	 * Note: you need to insert this mixin before your actual component definition in order to override the
	 * settings here!
	 * 
	 * Example:
	 *     Polymer('your-element', Polymer.mixin({}, CbnAbstractInputMixin, {
	 *         // element's properties
	 *     }));
	 */
	var CbnAbstractInputMixin = {
		
		// Attributes and properties (just for documentation purposes):
		
		/**
		 * All `cbn-form`-embeddable inputs must have this set as a HTML attribute (which can be used as selector 
		 * to query for the inputs).
		 * 
		 * @attribute is-form-input
		 * @type {Boolean}
		 */
		isFormInput: true,
		
		/**
		 * This should be true for `"type"="file"` fields (which need special handling inside form's submit method).
		 * 
		 * All file inputs must also expose a {@link #getFiles} method that returns a FileList-compatible interface 
		 * to the selected files.
		 * 
		 * @attribute is-file-input
		 * @type {Boolean}
		 */
		isFileInput: false,
		
		
		/**
		 * Input's name. 
		 * 
		 * It is used as model binding path 
		 * For example, the value 'name.first_name' will bind to the model path `model.name.first_name`.
		 * 
		 * @attribute name
		 * @type {String}
		 */
		
		/**
		 * Input's value attribute.
		 * Should be String for most of the cases, Array if the input supports multiple values and Object for
		 * special input types (e.g. file). And array of objects for special types with multiple values, ofc. ;)
		 * 
		 * @attribute value
		 * @type { Array | Object | [String] | [Object]}
		 */
		
		/**
		 * Whether the current instance should be shown as preview in form groups.
		 * 
		 * @attribute preview
		 * @type {Boolean}
		 */
		
		/**
		 * Is the input currently in a preview state?
		 * 
		 * Automatically bound by the `cbn-form-group` component if the {@link #preview} property is true.
		 * 
		 * @attribute previewstate
		 * @type {Boolean}
		 */
		
		
		// DOM Properties:
		
		/**
		 * Defines input element's dynamically-configurable attributes.
		 * 
		 * Note that 'value' and 'previewstate' are automatically-bound attributes and don't need to be enumerated 
		 * here.
		 * 
		 * @type {[String]}
		 */
		inputAttributes: [ "type", "name", "preview" ],
		
		/**
		 * Optional properties to pass to the parent decorator element (if any).
		 * 
		 * Use if you require special treatment from the decorator. Only used by the dynamic form.
		 * 
		 * @type {Object}
		 */
		decoratorConfig: {},
		
		/**
		 * Stores the parent `cbn-form` element.
		 * 
		 * @type {HTMLElement}
		 */
		parentForm: null,
		
		
		// Element lifecycle handlers:
		
		/**
		 * Element instance created callback.
		 * 
		 * Use `CbnAbstractInputMixin.created.apply(this)` if you want to override it.
		 */
		created: function () {
			// nothing yet
		}, 
		
		/**
		 * Polymer element ready callback.
		 * 
		 * Use `CbnAbstractInputMixin.ready.apply(this)` if you want to override it.
		 */
		ready: function () {
			// nothing yet
		},
		
		/**
		 * Sends an event to notify the parent containers of this input's existence in their DOM.
		 * 
		 * Use `CbnAbstractInputMixin.attached.apply(this)` if you want to override it.
		 */
		attached: function () {
			var input = this;
			this.async(function(){
				this.fire('cbn-form-input-attached', {
					input: input, 
					bindValue: true
				}, null, true, false);
			});
		},
		
		/**
		 * Sends an event to notify the parent containers of this input's detachment from their DOM.
		 * 
		 * Use `CbnAbstractInputMixin.detached.apply(this)` if you want to override it.
		 */
		detached: function () {
			var input = this;
			this.fire('cbn-form-input-detached', {
				input: input, 
				unbindValue: true
			}, null, true, false);
		},
		
		// Fired events:
		
		/**
		 * Fired automatically when an input attaches. 
		 * Bubbles up the DOM tree.
		 * 
		 * @event cbn-form-input-attached
		 */
		
		/**
		 * Fired automatically when an input is detached from DOM. 
		 * Bubbles up the DOM tree.
		 * 
		 * @event cbn-form-input-detached
		 */
		
		
		// Element API methods: 
		
		/**
		 * Requests validation of the input (called by the form element before submit).
		 * 
		 * The input element is responsible for showing / highlighting the error to the user.
		 * 
		 * @return True if the input validates, false otherwise.
		 */
		validate: function () {
			return true;
		}, 
		
		/**
		 * This method should be implemented by file inputs.
		 * Used by the primary form component to send the uploaded files via AJAX.
		 * 
		 * @return {FileList} A FileList (preferably) object that contains the selected files.
		 */
		getFiles: function () {
			throw "Not implemented!";
		}
		
	};
	
	/**
	 * Defines the abstract interface to be implemented by the custom input decorators.
	 * 
	 * An input decorator is an element that wraps the actual input inside (via light DOM) and can show several other UI 
	 * elements around it (such as labels, validation errors etc.).
	 * 
	 * Note: you need to insert this mixin before your actual component definition in order to override the
	 * settings here!
	 * 
	 * Example:
	 *     Polymer('your-decorator', Polymer.mixin({}, CbnAbstractInputDecoratorMixin, {
	 *         // element's properties
	 *     }));
	 */
	var CbnAbstractInputDecoratorMixin = {
		
		/**
		 * Whether the current instance should be shown as preview in form groups.
		 * 
		 * @attribute preview
		 * @type {Boolean}
		 */
		preview: false,
		
		/**
		 * Is the input container currently in a preview state?
		 * 
		 * Automatically bound by the `cbn-form-group` component if the {@link #preview} property is true.
		 * 
		 * @attribute previewstate
		 * @type {Boolean}
		 */
		previewstate: false,
		
		/**
		 * Defines decorator's dynamically-configurable attributes.
		 * 
		 * Note 'previewstate' is automatically-bound and donesn't need to be enumerated here.
		 * 
		 * @type {[String]}
		 */
		decoratorAttributes: [ "label", "preview" ], 
		
		
		// Element lifecycle methods:
		
		/**
		 * Element instance created callback.
		 * 
		 * Use `CbnFormModelBindingMixin.created.apply(this)` if you want to override it.
		 */
		created: function () {
			// nothing yet
		}, 
		
		/**
		 * Polymer element ready callback.
		 * 
		 * Use `CbnFormModelBindingMixin.ready.apply(this)` if you want to override it.
		 */
		ready: function () {
			// nothing yet
		}
		
	};
	
	// noinspection JSUnusedGlobalSymbols
	/**
	 * A mixin that implements utility model value binding methods.
	 * 
	 * Used by model containers (cbn-form, cbn-dynamic-form etc.) to bind to the value attributes when an input is 
	 * attached.
	 * 
	 * Example:
	 *     Polymer('your-element', Polymer.mixin({
	 *         // element's properties
	 *     }, CbnFormModelBindingMixin));
	 */
	var CbnFormModelBindingMixin = {
		
		/**
		 * Binds an observer to the given model to an input's value property.
		 * 
		 * @param {HTMLElement} input The target input to bind to.
		 */
		bindValue: function(input) {
			// HACK / workaround for a typo bug in the Node.bind() library 
			if (input.bindings_ && input.bindings_['value']) {
				input.bindings_['value'].close();
				input.bindings_['value'] = undefined;
			}
			input.bind('value', new PathObserver(this.model, input.name));
			input._valueBoundParent = this;
		},
		
		/**
		 * Unbinds the observer for an input's value property.
		 * 
		 * @param {HTMLElement} input The target input to unbind.
		 * @param {Boolean} force Set to true to force unbinding (even if the owner is not 'this').
		 */
		unbindValue: function(input, force) {
			if (force || input._valueBoundParent == this) {
				// the element will automatically be unbound by Polymer after being detached
				// so we only need to update the input's model controller
				input._valueBoundParent = null;
			}
		}
		
	};
	
</script>
