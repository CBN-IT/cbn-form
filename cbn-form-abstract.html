<!--
This file defines the common utilities and interfaces necessary by some components.

Each input element must implement CbnAbstractInputMixin's abstract methods, have a declared `is-form-input` HTML 
attribute and register its input type[s] via the {@link CbnFormInputs#registerType} (used for dynamic form input 
type discovery).
-->

<script>
	
	/**
	 * Class used by the inputs to register their capabilities with the `cbn-form` library.
	 */
	var CbnFormInputs = {
		
		/**
		 * Stores the registered inputs by type.
		 * The key is the input type and the value is the element's name.
		 * 
		 * @type { Object.<String, String> }
		 */
		_registeredTypes: {},
		
		/**
		 * Stores the registered elements as a Boolean map.
		 * 
		 * @type { Object.<String, Boolean> }
		 */
		_registeredElements: {},
		
		/**
		 * Registers a new input element to be usable within `cbn-form`.
		 * 
		 * @param {String} typeName The input `type` (e.g. text / number / date) provided by the element.
		 * @param {String} element The name of the custom input element.
		 */
		registerType: function (typeName, element) {
			if (this._registeredTypes[typeName] != undefined)
				return false;
			
			this._registeredTypes[typeName] = element;
			this._registeredElements[element] = true;
			
			return true;
		}
		
	};
	
	
	/**
	 * Defines the abstract interface to be implemented by the custom input elements.
	 * 
	 * Note: you need to insert this mixin before your actual component definition in order to override the
	 * settings here!
	 * 
	 * Example:
	 *     Polymer('your-element', Polymer.mixin({}, CbnAbstractInputMixin, {
	 *         // element's properties
	 *     }));
	 */
	var CbnAbstractInputMixin = {
		
		// Attributes and properties:
		
		/**
		 * All `cbn-form`-embeddable inputs must have this set as a HTML attribute (which can be used as selector 
		 * to query for the inputs).
		 * 
		 * @attribute is-form-input
		 * @type {Boolean}
		 */
		isFormInput: true,
		
		/**
		 * This should be true for `"type"="file"` fields (which need special handling inside form's submit method).
		 * 
		 * All file inputs must also expose a {@link #getFiles} method that returns a FileList-compatible interface 
		 * to the selected files.
		 * 
		 * @attribute is-file-input
		 * @type {Boolean}
		 */
		isFileInput: false,
		
		/**
		 * Input's name. 
		 * 
		 * It is used as model binding path 
		 * For example, the value 'name.first_name' will bind to the model path `model.name.first_name`.
		 * 
		 * @attribute name
		 * @type {String}
		 */
		name: '',
		
		/**
		 * Input's value attribute.
		 * Should be String for most of the cases, Array if the input supports multiple values and Object for
		 * special input types (e.g. file). And array of objects for special types with multiple values, ofc. ;)
		 * 
		 * @attribute value
		 * @type { Array | Object | [String] | [Object]}
		 */
		value: null,
		
		/**
		 * Whether the current instance should be shown as preview in form groups.
		 * 
		 * @attribute preview
		 * @type {Boolean}
		 */
		preview: false,
		
		/**
		 * Is the input currently in a preview state?
		 * 
		 * Automatically bound by the `cbn-form-group` component if the {@link #preview} property is true.
		 * 
		 * @attribute previewstate
		 * @type {Boolean}
		 */
		previewstate: false,
		
		/**
		 * Defines input element's dynamically-configurable attributes. Again, should be just a DOM property.
		 * 
		 * Note that 'value' and 'previewstate' are automatically-bound attributes and don't need to be enumerated 
		 * here.
		 * 
		 * @type {[String]}
		 */
		inputAttributes: [ "type", "name", "preview" ],
		
		/**
		 * Optional properties to pass to the parent decorator element (if any).
		 * 
		 * Use if you require special treatment from the decorator. Only used by the dynamic form.
		 * 
		 * @type {Object}
		 */
		decoratorConfig: {},
		
		/**
		 * Stores the parent `cbn-form` element. DOM property.
		 * 
		 * @type {HTMLElement}
		 */
		parentForm: null,
		
		
		// Element lifecycle methods:
		
		/**
		 * Element instance created callback.
		 * 
		 * Use `CbnAbstractInputMixin.created.apply(this)` if you want to override it.
		 */
		created: function () {
			// nothing yet
		}, 
		
		/**
		 * Polymer element ready callback.
		 * 
		 * Use `CbnAbstractInputMixin.ready.apply(this)` if you want to override it.
		 */
		ready: function () {
			// nothing yet
		},
		
		/**
		 * Sends an event to notify the parent containers of this input's existence in their DOM.
		 * 
		 * Use `CbnAbstractInputMixin.attached.apply(this)` if you want to override it.
		 */
		attached: function () {
			var input = this;
			this.async(function(){
				this.fire('cbn-form-input-attached', {
					input: input, 
					bindValue: true
				}, null, true, false);
			});
		},
		
		/**
		 * Sends an event to notify the parent containers of this input's detachment from their DOM.
		 * 
		 * Use `CbnAbstractInputMixin.detached.apply(this)` if you want to override it.
		 */
		detached: function () {
			var input = this;
			this.fire('cbn-form-input-detached', {
				input: input, 
				unbindValue: true
			}, null, true, false);
		},
		
		// Fired events:
		
		/**
		 * Fired automatically when an input attaches. 
		 * Bubbles up the DOM tree.
		 * 
		 * @event cbn-form-input-attached
		 */
		
		/**
		 * Fired automatically when an input is detached from DOM. 
		 * Bubbles up the DOM tree.
		 * 
		 * @event cbn-form-input-detached
		 */
		
		
		// Element methods: 
		
		/**
		 * Requests validation of the input (called by the form element before submit).
		 * 
		 * The input element is responsible for showing / highlighting the error to the user.
		 * 
		 * @return True if the input validates, false otherwise.
		 */
		validate: function () {
			return true;
		}, 
		
		/**
		 * This method should be implemented by file inputs.
		 * Used by the primary form component to send the uploaded files via AJAX.
		 * 
		 * @return {FileList} A FileList (preferably) object that contains the selected files.
		 */
		getFiles: function () {
			throw "Not implemented!";
		}
		
	};
	
	/**
	 * Defines the abstract interface to be implemented by the custom input decorators.
	 * 
	 * An input decorator is an element that wraps the actual input inside (via local DOM) and can show several other UI 
	 * elements around it (such as labels, validation errors etc.).
	 * 
	 * Note: you need to insert this mixin before your actual component definition in order to override the
	 * settings here!
	 * 
	 * Example:
	 *     Polymer('your-decorator', Polymer.mixin({}, CbnAbstractInputDecoratorMixin, {
	 *         // element's properties
	 *     }));
	 */
	var CbnAbstractInputDecoratorMixin = {
		
		/**
		 * Whether the current instance should be shown as preview in form groups.
		 * 
		 * @attribute preview
		 * @type {Boolean}
		 */
		preview: false,
		
		/**
		 * Is the input container currently in a preview state?
		 * 
		 * Automatically bound by the `cbn-form-group` component if the {@link #preview} property is true.
		 * 
		 * @attribute previewstate
		 * @type {Boolean}
		 */
		previewstate: false,
		
		/**
		 * Defines decorator's dynamically-configurable attributes.
		 * 
		 * Note 'previewstate' is automatically-bound and donesn't need to be enumerated here.
		 * 
		 * @type {[String]}
		 */
		decoratorAttributes: [ "label", "preview" ], 
		
		
		// Element lifecycle methods:
		
		/**
		 * Element instance created callback.
		 * 
		 * Use `CbnFormModelBindingMixin.created.apply(this)` if you want to override it.
		 */
		created: function () {
			// nothing yet
		}, 
		
		/**
		 * Polymer element ready callback.
		 * 
		 * Use `CbnFormModelBindingMixin.ready.apply(this)` if you want to override it.
		 */
		ready: function () {
			// nothing yet
		}
		
	};
	
	
	/**
	 * A mixin that implements utility model value binding methods.
	 * 
	 * Used by model containers (cbn-form, cbn-dynamic-form etc.) to bind to the value attributes when an input is 
	 * attached.
	 * 
	 * Example:
	 *     Polymer('your-element', Polymer.mixin({
	 *         // element's properties
	 *     }, CbnFormModelBindingMixin));
	 */
	var CbnFormModelBindingMixin = {
		
		/**
		 * Binds an observer to the given model to an input's value attribute.
		 * 
		 * @param {HTMLElement} input The target input to bind to.
		 */
		bindValue: function(input) {
			this.unbindValue(input, true);
			input.bind('value', new PathObserver(this.model, input.name));
			input._valueBoundParent = this;
		},
		
		/**
		 * Unbinds the observers for an input's value attribute.
		 * 
		 * @param {HTMLElement} input The target input to unbind.
		 * @param {Boolean} force Set to true to force unbinding (even if the owner is not 'this').
		 */
		unbindValue: function(input, force) {
			if (force || input._valueBoundParent == this) {
				if (input.valueObservable_ && input.valueObservable_.close) {
					input.valueObservable_.close();
				}
				input._valueBoundParent = null;
			}
		}
		
	};
	
</script>
