<!--
`cbn-form-group` groups multiple form fields together inside a logical group with several 
visual features (preview / edit stances etc.).

@group cbn-form
@element cbn-form-group
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="cbn-dynamic-input.html">

<polymer-element name="cbn-form-group">
	<template>
		<link rel="stylesheet" href="cbn-form-group.css">
		
		<paper-shadow id="container" z="0" animated>
			<template if="{{caption}}">
				<div class="caption">{{caption}}</div>
			</template>
			
			<div id="content" class="{{ { preview: previewState } | tokenList}}">
				<content></content>
			</div>
			
		</paper-shadow>
	</template>
	
	<script>
		(function() {
			
			/**
			 * Global variable that stores the currently open form group.
			 * 
			 * @type {HTMLElement}
			 */
			var currentlyOpenGroup = null;
			
			Polymer('cbn-form-group', {
				
				publish: { // Published attributes: 
					
					/**
					 * Form group's caption.
					 * 
					 * @attribute caption
					 * @type {String}
					 * @default ''
					 */
					caption: '',
					
					/**
					 * Whether the group is toggleable (with preview / edit states) or not (edit-only).
					 * 
					 * @attribute toggleable
					 * @type {Boolean}
					 * @default true
					 */
					toggleable: true,
					
					/**
					 * Whether the form group is currently preview-only or in editable state.
					 * 
					 * @attribute preview-state
					 * @type {Boolean}
					 * @default true
					 */
					previewState: true
				}, 
				
				
				/**
				 * Fires when the element is created. Used to initialize its attributes.
				 */
				created: function () {
					
				},
				
				/**
				 * Called when polymer element has been fully prepared.
				 */
				ready: function() {
					var currentGroup = this;
					
					if (this.toggleable) {
						this.close();
						
						// stop click event propagation (so the group won't get closed)
						this.addEventListener('click', function(event) {
							event.stopPropagation();
							currentGroup.open();
						}, false);
						
					} else {
						this.previewState = false;
					}
					
					// Bind the magic 'previewstate' attribute to the form inputs
					this.addEventListener('cbn-form-input-attached', function (event) {
						var target = event.path[0];
						if (target._attachedFormGroup != currentGroup) {
							target._attachedFormGroup = currentGroup;
							
							target.bind('previewstate', new PathObserver(currentGroup, 'previewState'));
						}
					});
					
					this.addEventListener('cbn-form-input-detached', function (event) {
						var target = event.path[0];
						if (target._attachedFormGroup == currentGroup) {
							target._attachedFormGroup = null;
							target.unbind('previewstate');
						}
					});
				},
				
				/**
				 * Opens the group element.
				 */
				open: function () {
					if (!this.toggleable) 
						return;
					
					if (currentlyOpenGroup && currentlyOpenGroup != this)
						currentlyOpenGroup.close();
					this.previewState = false;
					this.$.container.setZ(1);
					
					currentlyOpenGroup = this;
				},
				
				/**
				 * Closes the current group, if open.
				 */
				close: function () {
					if (!this.toggleable) 
						return;
					
					this.previewState = true;
					this.$.container.setZ(0);
					
					if (currentlyOpenGroup == this)
						currentlyOpenGroup = null;
				}
				
			});
			
			/*
			 * Capture all document click events and close the currently open group.
			 * 
			 * The event is interrupted (i.e. its propagation is stopped) when clicking 
			 * inside a form group element.
			 */
			document.addEventListener("click", function(event) {
				var i;
				if (currentlyOpenGroup) {
					var found = false;
					if (event.path) {
						for (i = 0; i < event.path.length; i++) {
							if (event.path[i].tagName && event.path[i].tagName.toLowerCase() == 'cbn-form-group' && 
									currentlyOpenGroup == this)
								found = true;
						}
					}
					if (!found)
						currentlyOpenGroup.close();
				}
			}, false);
			
		})();
		
	</script>
	
</polymer-element>
