<!--
`cbn-form-group` groups multiple form fields together inside a logical group with several 
visual features (preview / edit stances etc.).

@group cbn-form
@element cbn-form-group
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="lib/include.html">

<polymer-element name="cbn-form-group">
	<template>
		<link rel="stylesheet" href="cbn-form-group.css">

		<paper-shadow id="container" z="1" animated style="background-color: white;">
			<template if="{{caption}}">
				<div class="caption">{{caption}}</div>
			</template>

			<div id="content" class="{{ { preview: previewState } | tokenList}}">
				<content></content>
			</div>

		</paper-shadow>
	</template>

	<script>
		(function() {

			/**
			 * Global variable that stores the currently open form group.
			 */
			var currentlyOpenGroup = null;

			Polymer('cbn-form-group', Polymer.implementBehaviors({

				publish: { // Published attributes: 

					/**
					 * Form group's caption.
					 *
					 * @attribute caption
					 * @type {String}
					 * @default ''
					 */
					caption: '',

					/**
					 * Whether the group is toggleable (with preview / edit states) or not (edit-only).
					 *
					 * @attribute toggleable
					 * @type {Boolean}
					 * @default true
					 */
					toggleable: false,

					/**
					 * Whether the form group is currently preview-only or in editable state.
					 *
					 * @attribute preview-state
					 * @type {Boolean}
					 * @default true
					 */
					previewState: true
				},

				/** @namespace this.$.container */

				/**
				 * Element's dynamically-configurable attributes.
				 */
				dynamicAttributes: {
					"caption" : { type: 'attribute' },
					"toggleable" : { type: 'attribute' },
					"previewState" : { type: 'attribute' }
				},

				/**
				 * Fires when the element is created. Used to initialize its attributes.
				 */
				created: function () {
					// nothing here
				},

				/**
				 * Called when polymer element has been fully prepared.
				 */
				ready: function() {
					var currentGroup = this;

					// stop click event propagation (so the group won't get closed)
					this.addEventListener('click', function(event) {
						if (currentGroup.toggleable) {
							event.stopPropagation();
							currentGroup.open();
						}
					}, false);

					// Bind the magic 'previewState' attribute to the form inputs
					this.addEventListener('cbn-form-control-attached', function (event) {
						var target = event.detail.element;
						if (target._parentFormGroup != currentGroup) {
							target._parentFormGroup = currentGroup;

							target.bind('previewState', new PathObserver(currentGroup, 'previewState'));
						}
					});

					this.addEventListener('cbn-form-control-detached', function (event) {
						var target = event.detail.element;
						if (target._parentFormGroup == currentGroup) {
							target._parentFormGroup = null;
						}
					});

					this.toggleableChanged();
				},

				toggleableChanged: function() {
					if (this.toggleable) {
						this.close();

					} else {
						this.open();
					}
				},

				/**
				 * Opens the group element.
				 */
				open: function () {
					if (this.toggleable) {
						if (currentlyOpenGroup && currentlyOpenGroup != this)
							currentlyOpenGroup.close();
						currentlyOpenGroup = this;
					}
					this.previewState = false;
				},

				/**
				 * Closes the current group, if open.
				 */
				close: function () {
					if (currentlyOpenGroup == this)
						currentlyOpenGroup = null;
					this.previewState = true;
				}

			}, CbnForm.AbstractContainer, CbnForm.DynamicControl ));

			/*
			 * Capture all document click events and close the currently open group.
			 * 
			 * The event is interrupted (i.e. its propagation is stopped) when clicking 
			 * inside a form group element.
			 */
			document.addEventListener("click", function(event) {
				var i;
				if (currentlyOpenGroup) {
					var found = false;
					if (event.path) {
						for (i = 0; i < event.path.length; i++) {
							if (event.path[i].tagName && event.path[i].tagName.toLowerCase() == 'cbn-form-group' &&
								currentlyOpenGroup == this)
								found = true;
						}
					}
					if (!found)
						currentlyOpenGroup.close();
				}
			}, false);

			//noinspection JSCheckFunctionSignatures
			CbnForm.registerElement('cbn-form-group', {
				types: ['group', '']
			});

		})();

	</script>

</polymer-element>
