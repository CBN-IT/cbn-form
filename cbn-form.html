<!--
`cbn-form` is an extensible ajax form component that manages a set of custom input elements and submits the data via XHR.

Supports AJAX file upload.

Example:
```
    <form is="cbn-form" action="/do/something/save" method="post">
    	Form fields here...
    </form>
```

@group cbn-form
@element cbn-form
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="lib/include.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>
	
	Polymer({
		is: 'cbn-form',
		
		extends: 'form',
		
		properties: {
			
			/**
			 * Content type to use when sending data. Also affects form model serialization.
			 * 
			 * Available content types: 
			 * 
			 * - 'application/x-www-form-urlencoded': the form will be serialized to a String using the urlencode convention;
			 * - 'multipart/form-data': the form will be sent using a FormData object; supports file uploads;
			 * - 'application/json': the entire model will be serialized as a JSON string and sent as POST body.
			 */
			contentType: {
				type: String,
				value: "application/x-www-form-urlencoded"
			},
			
			/**
			 * Additional query string arguments to append to the action URL when submitting the request.
			 * 
			 * If specified, must be a plain JSON key-value map of GET parameters.
			 */
			params: {
				type: Object
			},
			
			/**
			 * Form serialization method to use for submitting the form data.
			 * Only used if a form model object is used (i.e. the `model` attribute is not null).
			 * 
			 * Specifies how to serialize a (possibly) complex model object to a format recognized by the HTTP 
			 * protocol / server.
			 * 
			 * You only need to specify the 'mode' and their options (if you desire other behavior than the default).
			 * The `as` option is automatically detected and filled from the `contentType` attribute and/or form contents.
			 * 
			 * Available modes:
			 * 
			 * - `plain`: the model's own properties are returned as parameters; objects deeper than that are serialized 
			 *            using JSON;
			 * - `deep`: the model is recursively traversed and its values are appended as separate parameters (using the 
			 *            path within the object as name);
			 * - `json`: the entire model is serialized as a JSON object and stored inside a single parameter (by default, 
			 *           'data', but it can be overridden).
			 * 
			 * See {@link CbnForm.Serialization} for documentation on all serialization formats supported and their 
			 * options.
			 */
			serializationOptions: {
				type: Object,
				value: function() {
					return { mode: 'plain' };
				}
			},
			
			/**
			 * If given, the form element will use a custom `iron-ajax` instance to submit its requests that matches the 
			 * given selector. Useful if you want to supply advanced parameters for the ajax requests.
			 * 
			 * The `iron-ajax` element must exist at creation time (i.e. won't work if present inside a template).
			 * 
			 * And make sure it doesn't have the `auto` attribute set ;) 
			 */
			customAjax: {
				type: String,
				value: ''
			}
			
		},
		
		behaviors: [
			CbnForm.FormContainer
		],
		
		listeners: {
			'submit': '_onSubmit'
		},
		
		// Events
		
		/**
		 * Fired if the form cannot be submitted because it's invalid.
		 * 
		 * @event cbn-form-invalid
		 */
		
		/**
		 * Fired before the form is submitted (preventable).
		 * 
		 * If you want to prevent it temporarily (and then submit again, asynchronously), you can call `submit` with the 
		 * `true` argument (which means it won't fire this event a second time).
		 * 
		 * @event cbn-form-before-submit
		 */
		
		/**
		 * Fired after the form is submitted.
		 * 
		 * Detail properties:
		 * 
		 * - `data`: the serialized data that has been submitted;
		 * - `request`: reference to the `iron-request` object used for making the request.
		 * 
		 * @event cbn-form-submit
		 */
		
		/**
		 * Fired after the form is submitted and a response is received.
		 * 
		 * The detail object contains the `request` and the `response` keys.
		 * 
		 * @event cbn-form-response
		 */
		
		/**
		 * Fired after the form is submitted and an error is received.
		 * 
		 * The detail object contains the `request` and the `error` keys.
		 * 
		 * @event cbn-form-error
		 */
		
		
		// Private properties:
		
		/**
		 * Stores reference to the `iron-ajax` that is used for submitting.
		 * It is either an internally-generated one, or, if the user supplies {@link #customAjax}, it refers to that 
		 * element (if found).
		 */
		_ironAjax: null,
		
		/**
		 * Maps the content types to the serialization settings to use for `CbnForm.Serialization`.
		 * @type {Object<String,String>}
		 */
		_serializationMap: {
			'application/x-www-form-urlencoded': { as: 'urlencoded' },
			'multipart/form-data': { as: 'FormData' },
			'application/json': { as: 'json' }
		},
		
		// Public API:
		
		/**
		 * Called when the for is submitted.
		 * You can also call this if you want to manually trigger the submission method.
		 * 
		 * @param {Boolean} [noPrevent] Set to true to prevent firing the `cbn-form-before-submit` event.
		 */
		submit: function(noPrevent) {
			// first, validate the form
			if (!this.noValidate && !this.validate()) {
				this.fire('cbn-form-invalid');
				return;
			}
			
			if (!noPrevent) {
				var ev = this.fire('cbn-form-before-submit', {}, {
					cancelable: true
				});
				if (ev.defaultPrevented) return;
			}
			
			var data = this.serialize();
			
			if (!this._ironAjax || !this.action) 
				return false;
			
			this._ironAjax.url = this.action;
			this._ironAjax.method = this.method;
			this._ironAjax.params = this.params;
			this._ironAjax.contentType = this.contentType;
			
			if (this.method.toUpperCase() == 'GET') {
				if (this._ironAjax.params) {
					this._ironAjax.params = JSON.parse(JSON.stringify(this._ironAjax.params));
				} else {
					this._ironAjax.params = {};
				}
				// and extend it with the form data object
				Polymer.Base.mixin(this._ironAjax.params, data);
				
			} else {
				this._ironAjax.body = data;
			}
			
			var request = this._ironAjax.generateRequest();
			
			this.fire('cbn-form-submit', {
				request: request,
				data: data
			});
		},
		
		/**
		 * Uses the `CbnForm.Serialization` library to serialize the form's contents.
		 * 
		 * If a form model is used, the serialization will use it with the given serialization options.
		 * Otherwise, the form's elements will be iterated and serialized instead (using the `as` format specified inside 
		 * `serializationOptions`).
		 * 
		 * You can customize the output serialization format using `serializationOptions`.
		 * 
		 * @param {CbnForm.SerializationOptions} [serializationOptions] Override the form's serialization options.
		 */
		serialize: function(serializationOptions) {
			if (!serializationOptions)
				serializationOptions = this.serializationOptions;
			
			var contentType = this.contentType;
			
			serializationOptions = JSON.parse(JSON.stringify(serializationOptions));
			if (!serializationOptions.as) { // autodetect from method, content type etc.
				if (this.method.toUpperCase() == 'GET') {
					// GET only accepts the params as a key-value map
					serializationOptions.as = 'jsonMap';
					
				} else if (this._serializationMap[contentType]) {
					/** @namespace Polymer.Base */
					Polymer.Base.mixin(serializationOptions, this._serializationMap[contentType]);
					
				} else {
					// just default to urlencoded, but the request will not be well-formed
					serializationOptions.as = 'urlencoded';
				}
			}
			
			if (this.model) {
				return CbnForm.Serialization.serialize(this.model, serializationOptions);
			} else {
				var params = CbnForm.Serialization.serializeFormElements(/**@type [HTMLElement]*/(this.formElements));
				return CbnForm.Serialization.serialize(params, serializationOptions);
			}
		},
		
		
		// Implementation (callbacks, private methods):
		
		/**
		 * The component is ready to use.
		 */
		ready: function() {
			this._handleFormResponse = this._handleFormResponse.bind(this);
			this._handleFormError = this._handleFormError.bind(this);
		},
		
		/**
		 * After the element is attached to the DOM, search its light children for a custom `iron-ajax` to use.
		 * If not found, create one (for internal use only).
		 */
		attached: function() {
			if (this.customAjax) {
				this._ironAjax = this.$$(this.customAjax);
				
				if (!this._ironAjax) {
					console.warn('`cbn-form`: invalid iron-ajax selector (element not found)', this.customAjax);
				}
				
			} else {
				this._ironAjax = document.createElement('iron-ajax');
			}
			
			if (this._ironAjax) {
				this._ironAjax.addEventListener('response', this._handleFormResponse);
				this._ironAjax.addEventListener('error', this._handleFormError);
			}
		},
		
		/**
		 * If a custom `iron-ajax` was used, need to detach the event handlers from it.
		 */
		detached: function() {
			if (this._ironAjax) {
				this._ironAjax.removeEventListener('response', this._handleFormResponse);
				this._ironAjax.removeEventListener('error', this._handleFormError);
			}
		},
		
		/**
		 * Form submit handler, used to interrupt the HTML form's native submit handler and call our own.
		 * 
		 * @param {Event} event The `submit` event object.
		 * @returns {boolean} Whether to continue with the native submission.
		 * @private
		 */
		_onSubmit: function (event) {
			if (event) {
				event.preventDefault();
			}
			this.submit();
			return false;
		},
		
		/**
		 * Handles the `iron-ajax` response event.
		 * 
		 * @param event The `response` event's object.
		 * @private
		 */
		_handleFormResponse: function(event) {
			this.fire('cbn-form-response', {
				request: event.detail,
				response: event.detail.response
			});
		},
		
		/**
		 * Handles the `iron-ajax` error event.
		 *
		 * @param event The `error` event's object.
		 * @private
		 */
		_handleFormError: function (event) {
			this.fire('cbn-form-error', {
				request: event.detail.request,
				error: event.detail.error
			});
		}
		
	});
	
</script>
