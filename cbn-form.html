<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../cbn-grid/cbn-grid.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../datetime-picker/overlay-date-picker.html">
<link rel="import" href="../cbn-datepicker/cbn-datepicker.html">

<dom-module id="cbn-form">
    <template>
        <style>
            :host {
                display: block;
            }
            paper-item{
                padding: 10px;
            }
            paper-input,paper-dropdown-menu-light,cbn-datepicker{
                padding: 0 10px;
            }
            paper-dropdown-menu-light{
                --paper-menu-button-dropdown:{
                    margin-top:46px;
                };
            }

        </style>
        <style include="iron-flex cbn-grid"></style>
            <div>
                <iron-form id="wrapper" on-iron-form-presubmit="presubmit" on-iron-form-response="savedForm">
                    <form id="form" method$={{method}} action$="{{url}}" class="horizontal layout wrap"></form>
                </iron-form>
            </div>
    </template>

    <script>
        /**
         * `cbn-form`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class CbnForm extends Polymer.Element {
            static get is() {
                return 'cbn-form';
            }

            static get properties() {
                return {
                    config: {
                        type: Object
                    },
                    model: {
                        type: Object
                    },
                    form: {
                        type: Object
                    },
                    url: {
                        type: String
                    },
                    method: {
                        type: String,
                        value: "get"
                    },
                    params: {
                        type: Object,
                        value: {}
                    }
                };
            }

            static get observers() {
                return [
                    'changedConfig(config)',
                    'changedModel(model.*)'
                ]
            }

            connectedCallback(){
                super.connectedCallback();
                this.$.form.addEventListener("value-changed",this.changedValue.bind(this), true);
            }
            changedConfig(){

                this.$.form.innerHtml = "";
                for(let i=0; i< this.config.elements.length; i++){
                    let field = this.config.elements[i];
                    let input;
                    if(field["type"] == "text") {
                        input = document.createElement('paper-input');
                        input.setAttribute("label", field["label"]);
                        input.setAttribute("name", field["name"]);
                        input.setAttribute("class", field["className"]);
                        input.setAttribute("auto-validate", true);

                        if (field["validation"] != undefined) {
                            input.setAttribute("required", field["validation"]["required"]);
                            if (field["validation"]["number"] != undefined && field["validation"]["number"]["validate"]) {
                                input.setAttribute("type", "number");
                            }
                        }
                    } else if(field["type"] == "select" && field["options"] != undefined ){
                        input = document.createElement('paper-dropdown-menu-light');
                        input.setAttribute("label", field["label"]);
                        input.setAttribute("name", field["name"]);
                        input.setAttribute("class", field["className"]);
                        input.setAttribute("auto-validate", true);
                        input.setAttribute("no-animations", true);
                        input.setAttribute("horizontal-align", "left");
                        if (field["validation"] != undefined) {
                            input.setAttribute("required", field["validation"]["required"]);
                        }

                        let options = document.createElement('paper-listbox');
                        options.setAttribute("slot", "dropdown-content");
                        options.setAttribute("attr-for-selected", "value");

                        for(let i=0; i< field["options"].length; i++){
                            let option = document.createElement('paper-item');
                            if(field["options"][i]["value"] != undefined){
                                option.setAttribute("value", field["options"][i]["value"]);
                                option.setAttribute("label", field["options"][i]["value"]);
                                option.innerHTML = field["options"][i]["label"];
                            } else {
                                option.setAttribute("value", field["options"][i]);
                                option.setAttribute("label", field["options"][i]["value"]);
                                option.innerHTML = field["options"][i];
                            }
                            options.appendChild(option);
                        }
                        input.appendChild(options);

                    } else if(field["type"] == "date"){
                        input = document.createElement("cbn-datepicker");
                        input.setAttribute("name", field["name"]);
                        if(field["minDate"] != undefined){
                            input.setAttribute("min-date", field["minDate"]);
                        }
                        if(field["maxDate"] != undefined){
                            input.setAttribute("max-date", field["maxDate"]);
                        }
                        if(field["defaultValue"] != undefined){
                            input.setAttribute("default-value", field["defaultValue"]);
                        }
//                        input.setAttribute("class", field["className"]);
                        input.setAttribute("no-overlap", true);

                    }
                    if(input != undefined){
                        this.$.form.appendChild(input);
                    }
                }
                this.changedModel();
            }

            changedModel(event){
                for(let i=0; i< this.config.elements.length; i++){
                    if(this.model != undefined){
                        let input = this.shadowRoot.querySelector("[name=" + this.config.elements[i]["name"] + "]");
                        if(input != undefined && input.value != this.model[this.config.elements[i]["name"]]){
                            input.value = this.model[this.config.elements[i]["name"]];
                        }
                    }
                }
            }

            changedValue(event){
//                console.log(event.path[0],event.path[0].getAttribute("name"));
                this.model[event.path[0].getAttribute("name")] = event.detail.value;
            }

            presubmit(){
                let params = {};
                if(window.namespace != undefined){
                    params["namespace"] = window.namespace;
                }

                let keysParams = Object.keys(this.params);
                for(let i=0; i<keysParams.length;i++){
                    params[keysParams[i]] = this.params[keysParams[i]];
                }

                let keysModel = Object.keys(this.model);
                for(let i=0; i<keysModel.length;i++){
                    params[keysModel[i]] = this.model[keysModel[i]];
                }

                this.$.wrapper.request.params = params;

            }

            submit(){
                this.$.wrapper.submit();
            }

            validate(){
                return this.$.wrapper.validate();
            }


        }

        window.customElements.define(CbnForm.is, CbnForm);
    </script>
</dom-module>
