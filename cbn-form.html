<link rel="import" href="../polymer/polymer-element.html">

<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../cbn-grid/cbn-grid.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../datetime-picker/overlay-date-picker.html">
<link rel="import" href="../cbn-datepicker/cbn-datepicker.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">

<dom-module id="cbn-form">
    <template>
        <style>
            :host {
                display: block;
            }
            paper-item{
                padding: 10px;
                min-width: 100px;
            }
            paper-input,paper-dropdown-menu-light,cbn-datepicker,paper-checkbox{
                padding: 0 10px;
            }
            paper-checkbox{
                margin: auto 0 15px 0;
            }
            paper-dropdown-menu-light{
                --paper-menu-button-dropdown:{
                    margin-top:46px;
                };
            }

        </style>
        <style include="iron-flex cbn-grid"></style>
            <div>
                <iron-form id="wrapper" on-iron-form-presubmit="presubmit">
                    <form id="form" method$={{method}} action$="{{url}}" class="horizontal layout wrap"></form>
                </iron-form>
            </div>
    </template>

    <script>
        /**
         * `cbn-form`
         *
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class CbnForm extends Polymer.Element {
            static get is() {
                return 'cbn-form';
            }

            static get properties() {
                return {
                    config: {
                        type: Object
                    },
                    model: {
                        type: Object,
                        value:function(){
                            return {};
                        },
                        notify: true
                    },
                    form: {
                        type: Object
                    },
                    url: {
                        type: String
                    },
                    method: {
                        type: String,
                        value: "get"
                    },
                    params: {
                        type: Object,
                        value: {}
                    },
                    /**
                     * An URL to fetch an unique upload URL.
                     *
                     * Useful for AppEngine file uploads using the provided dispatcher.
                     */
                    preUploadUrl: {
                        type: String,
                        value: '/GetUploadURL'
                    },

                    /**
                     * The pre-upload request parameter to send with the actual action URL.
                     */
                    preUploadUrlParam: {
                        type: String,
                        value: 'redirectUrl'
                    },
                    _generatedPreUploadUrl: {
                        type: String,
                        value: null
                    },
                    selectedLanguage: {
                        type: String,
                        value: function(){
                            return window["selectedLanguage"]
                        },
                        observer: "changedLanguage"
                    }
                };
            }

            static get observers() {
                return [
                    'changedConfig(config)',
                    'changedModel(model.*)'
                ]
            }

            connectedCallback(){
                super.connectedCallback();
                this.$.form.addEventListener("value-changed",this.changedValue.bind(this), true);
            }
            changedConfig(){

//                this.$.form.innerHtml = "";
                while (this.$.form.firstChild) {
                    this.$.form.removeChild(this.$.form.firstChild);
                }
                for(let i=0; i< this.config.elements.length; i++){
                    let field = this.config.elements[i];
                    let label = field["label"];
                    if(field["i18n"] !== undefined && this.selectedLanguage !== undefined){
                        label = field["i18n"][this.selectedLanguage];
                    }
                    let input;
                    if (field["type"] === "file") {
                        input = document.createElement('paper-upload');
                        input.setAttribute("label", field["label"]);
                        input.setAttribute("name", field["name"]);
                        input.setAttribute("class", field["className"]);
                        input.setAttribute("auto-validate", true);
                        input.multiple = field["multiple"] === true;
                        if (field["validation"] !== undefined && field["validation"] !== null) {
                            input.required = field["validation"]["required"] === true;
                        }

                    } else if(field["type"] === "text") {
                        input = document.createElement('paper-input');
                        input.setAttribute("label", label);
                        input.setAttribute("name", field["name"]);
                        input.setAttribute("class", field["className"]);
                        input.setAttribute("auto-validate", true);
                        input.disabled = field["disabled"];
                        if (field["validation"] != undefined) {
                            input.required = field["validation"]["required"];
                            input.minlength = field["validation"]["minLength"];
                            input.maxlength = field["validation"]["maxLength"];
                            input.allowedPattern =  field["validation"]["pattern"];
                            if (field["validation"]["number"] != undefined && field["validation"]["number"]["validate"]) {
                                input.setAttribute("type", "number");
                            }
                        }
                    } else if(field["type"] === "select" && field["options"] != undefined ){
                        input = document.createElement('paper-dropdown-menu-light');
                        input.setAttribute("label", label);
                        input.setAttribute("name", field["name"]);
                        input.setAttribute("class", field["className"]);
                        input.setAttribute("auto-validate", true);
                        input.setAttribute("no-animations", true);
                        input.setAttribute("horizontal-align", "left");
                        if (field["validation"] != undefined) {
                            input.required = field["validation"]["required"];
                        }

                        let options = document.createElement('paper-listbox');
                        options.setAttribute("slot", "dropdown-content");
                        options.setAttribute("attr-for-selected", "value");

                        for (let i = 0; i < field["options"].length; i++) {
                            let option = document.createElement('paper-item');
                            if (field["options"][i]["value"] != undefined) {
                                option.setAttribute("value", field["options"][i]["value"]);
                                option.setAttribute("label", field["options"][i]["value"]);
                                option.innerHTML = field["options"][i]["label"];
                            } else {
                                option.setAttribute("value", field["options"][i]);
                                option.setAttribute("label", field["options"][i]);
                                option.innerHTML = field["options"][i];
                            }
                            options.appendChild(option);
                        }
                        if (field["defaultValue"] != undefined) {
                            input["value"] = field["defaultValue"];
                        }
                        input.appendChild(options);

                    } else if (field["type"] === "date") {
                        input = document.createElement("cbn-datepicker");
                        input.setAttribute("name", field["name"]);
                        input.setAttribute("label", label);
                        input.setAttribute("class", field["className"]);
                        input.disabled = field["disabled"];
                        if (field["minDate"] != undefined) {
                            input.setAttribute("min-date", field["minDate"]);
                        }
                        if (field["maxDate"] != undefined) {
                            input.setAttribute("max-date", field["maxDate"]);
                        }
                        if (field["defaultValue"] != undefined) {
                            input.setAttribute("default-value", field["defaultValue"]);
                        }
//                        input.setAttribute("class", field["className"]);
                        input.setAttribute("no-overlap", true);

                    } else if (field["type"] === "checkbox") {
                        input = document.createElement("paper-checkbox");
                        input.setAttribute("class", field["className"]);
                        input.setAttribute("name", field["name"]);
                        input.textContent = label;
                        input.textContent = field["label"];
                        //                        input.setAttribute("class", field["className"]);
                        input.disabled = field["disabled"];
                        if (field["validation"] != undefined) {
                            input.required = field["validation"]["required"];
                        }
                        input.addEventListener("checked-changed", this.changedValue.bind(this), true);
                    }
                    if (input != undefined) {
                        this.$.form.appendChild(input);
                    }
                }
                this.changedModel();
            }

            changedLanguage(newValue, lastValue){
                if(lastValue !== undefined && newValue !== lastValue) {
                    if (this.config !== undefined) {
                        for (let i = 0; i < this.config.elements.length; i++) {
                            if (this.config.elements[i]["i18n"] !== undefined && this.config.elements[i]["i18n"][this.selectedLanguage] !== undefined) {
                                let input = this.shadowRoot.querySelector("[name=" + this.config.elements[i]["name"] + "]");
                                input.label = this.config.elements[i]["i18n"][this.selectedLanguage];
                            }
                        }
                    }
                }
            }

            changedModel(event){
                if(this.config != undefined){
                    for(let i=0; i< this.config.elements.length; i++){
                        if(this.model != undefined){
                            let input = this.shadowRoot.querySelector("[name=" + this.config.elements[i]["name"] + "]");
                            if(input != undefined && input.value != this.model[this.config.elements[i]["name"]]){
                                let newValue = "";
                                if(this.model[this.config.elements[i]["name"]] != undefined){
                                    newValue = this.model[this.config.elements[i]["name"]];
                                } else if(this.config.elements[i]["defaultValue"] != undefined){
                                    newValue = this.config.elements[i]["defaultValue"];
                                    this.set("model." + this.config.elements[i]["name"], newValue);
                                }
                                if(this.config.elements[i]["type"] === "checkbox"){
                                    input.checked = newValue;
                                } else {
                                    input.value = newValue;
                                }
                            }
                        }
                    }
                }
            }

            changedValue(event){
                if(this.model != undefined){
                    this.set("model." + event.target.name, event.detail.value);
                }
            }

            presubmit(event){
                let params = {};
                if(window.namespace != undefined){
                    params["namespace"] = window.namespace;
                }

                let keysParams = Object.keys(this.params);
                for(let i=0; i<keysParams.length;i++){
                    if(this.params[keysParams[i]] !== undefined){
                    params[keysParams[i]] = this.params[keysParams[i]];

                    }
                }

                let keysModel = Object.keys(this.model);
                for(let i=0; i<keysModel.length;i++){
                    params[keysModel[i]] = this.model[keysModel[i]];
                }
                let haveFile=false;
                for (let i = 0; i < this.config.elements.length; i++) {
                    let field = this.config.elements[i];
                    if (field["type"] === "file") {
                        let val = params[field["name"]];
                        if (val === undefined || val === null) {
                            continue;
                        }
                        if (val instanceof Array) {
                            for (let j = 0; j < val.length; j++) {
                                if (val[j].file !== undefined) {
                                    haveFile = true;
                                }
                            }
                        } else {
                            if (val.file !== undefined) {
                                haveFile = true;
                            }
                        }

                    }
                }
                if (haveFile) {
                    if(this._generatedPreUploadUrl===null){
                        //we need to generate an uload url;
                        event.preventDefault();

                        let getUloadRequest = document.createElement('iron-ajax');

                        getUloadRequest.addEventListener('response', function(event){
                            this._generatedPreUploadUrl = event.detail.response;
                            this.$.wrapper.submit();
                        }.bind(this));

                        getUloadRequest["handleAs"] = "text";
                        getUloadRequest.url = this.preUploadUrl;
                        getUloadRequest.method = 'GET';
                        getUloadRequest.headers = this.headers;
                        let params = {};
                        params[this.preUploadUrlParam]=this.$.wrapper.request.url;
                        getUloadRequest.params = params;
                        getUloadRequest.generateRequest();

                        return;
                    }
                    let formData = new FormData();
                    for (let name in params) {
                        if (!params.hasOwnProperty(name)) {
                            continue;
                        }
                        if (params[name] instanceof Array) {
                            for (let j = 0; j < params[name].length; j++) {
                                let val = params[name][j];
                                if (val.file !== undefined) {
                                    formData.append(name, val.file);
                                } else if (val.blobKey !== undefined) {
                                    formData.append(name + ".blobKey", val.blobKey);
                                } else {
                                    formData.append(name, val);
                                }
                            }
                        } else {
                            formData.append(name, params[name]);
                            console.log(name, params[name]);
                        }
                    }
                    this.$.wrapper.request.url = this._generatedPreUploadUrl;
                    this.$.wrapper.request.method = "post";
                    this.$.wrapper.request.body = formData;
                    this.$.wrapper.request.contentType = undefined;
                    this._generatedPreUploadUrl=null;
                } else {
                    if (this.method.toLowerCase() === "get") {
                        this.$.wrapper.request.params = params;
                    } else if (this.method.toLowerCase() === "post") {
                        this.$.wrapper.request.body = params;
                    }
                }
            }

            submit(){
                this.$.wrapper.submit();
            }

            validate(){
                return this.$.wrapper.validate();
            }


        }

        window.customElements.define(CbnForm.is, CbnForm);
    </script>
</dom-module>
