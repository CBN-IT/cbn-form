<!--
`cbn-form` is an extensible ajax form component that manages a set of custom input elements and submits the data via XHR.

Supports AJAX file upload.

Example:
```
    <cbn-form url="/do/something/save" method="post">
    	Form fields here...
    </cbn-form>
```

@group cbn-form
@element cbn-form
-->

<!-- Imports -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="cbn-form-group.html">

<polymer-element name="cbn-form" attributes="model url method params xhr-options serialization-options">
	<template>
		<style>
			:host { display: block; }
		</style>
		
		<!-- Insert form's content -->
		<content></content>
		
	</template>
	
	<script>
		Polymer('cbn-form', Polymer.mixin({
			
			/**
			 * Fired when submit command was issued.
			 * The event takes place before the actual submission (to the URL, if specified) is made and you can alter 
			 * its behavior or cancel it.
			 * 
			 * @event cbn-form-submit
			 */
			
			/**
			 * Fired if / when the form was successfully submitted.
			 * 
			 * @event cbn-form-ajaxSuccess
			 */
			
			/**
			 * Fired if the submission AJAX request failed.
			 * 
			 * @event cbn-form-ajaxError
			 */
			
			/**
			 * Fired if the submission AJAX request finished (with either error or success status; see core-xhr 
			 * documentation).
			 * 
			 * @event cbn-form-ajaxComplete
			 */
			
			// Element attributes
			
			/**
			 * Form's data model object.
			 * 
			 * @attribute model
			 * @type {Object}
			 * @default {}
			 */
			model: null,
			
			/**
			 * The URL to submit the form to.
			 * 
			 * @attribute url
			 * @type {String}
			 * @default ""
			 */
			url: "",
			
			/**
			 * The method to use for the submission.
			 * 
			 * @attribute method
			 * @type {String}
			 * @default "POST"
			 */
			method: "POST",
			
			/**
			 * Additional URL parameters to use.
			 * 
			 * @attribute params
			 * @type {Object}
			 * @default {}
			 */
			params: null,
			
			/**
			 * Additional options to pass to the XHR (see core-xhr documentation).
			 * 
			 * @attribute xhr-options
			 * @type {Object}
			 * @default {}
			 */
			xhrOptions: null,
			
			/**
			 * Form serialization method to use for submitting the form values via XHR.
			 * 
			 * Serialization types:
			 * - plain: passes the form data as a standard parameters map (each field has a separate parameter);
			 * - json: pass the entire model JSON as a form parameter (specified by the `param` property).
			 * 
			 * If asFormData is true, a FormData object will be returned (instead of a plain map).
			 * 
			 * If useBrackets is true, for multiple-valued inputs, array append brackets ('[]') will be automatically 
			 * added after the input's name.
			 * 
			 * @attribute serialization-options
			 * @type {{ type: String, param?: String, asFormData: Boolean, useBrackets: Boolean }}
			 * @default { type: 'plain', param: 'data', useBrackets: false }
			 */
			serializationOptions: null,
			
			
			// Internal fields
			
			/**
			 * Stores the list of input elements inside the form.
			 * 
			 * The list is maintained by listening for bubbling `cbn-form-input-attached` / `cbn-form-input-detached` 
			 * events.
			 * 
			 * @private
			 * @type {[HTMLElement]}
			 * @default []
			 */
			_formFields: null,
			
			
			// Functions and event handlers
			
			/**
			 * Fires when the element is created. Used to initialize its attributes.
			 */
			created: function() {
				if (!this.model)
					this.model = {};
				if (!this.params)
					this.params = {};
				if (!this.xhrOptions)
					this.xhrOptions = {};
				if (!this.serializationOptions)
					this.serializationOptions = { type: 'plain', param: 'data', useBrackets: false };
				
				this._formFields = [];
			},
			
			/**
			 * Called when polymer element has been fully prepared.
			 * 
			 * Listens for input attached / detached events and initializes them.
			 */
			ready: function() {
				var form = this;
				
				this.addEventListener('cbn-form-input-attached', function (event) {
					var input = event.detail.input;
					if (input.parentForm != form) {
						input.parentForm = form;
						this._formFields.push(input);
						
						if (event.detail.bindValue) {
							this.bindValue(input);
							event.detail.bindValue = false;
						}
					}
				});
				
				this.addEventListener('cbn-form-input-detached', function (event) {
					var input = event.detail.input;
					if (input.parentForm == form) {
						input.parentForm = null;
						var idx = this._formFields.indexOf(input);
						if (idx >= 0)
							this._formFields.splice(idx, 1);
						
						if (event.detail.unbindValue) {
							this.unbindValue(input);
							event.detail.unbindValue = false;
						}
					}
				});
			},
			
			/**
			 * Called when the model is changed.
			 */
			modelChanged: function() {
				var i;
				
				for (i=0; i<this._formFields.length; i++) {
					var input = this._formFields[i];
					if (input._valueBoundParent == this) {
						this.bindValue(input);
					}
				}
			}, 
			
			/**
			 * Requests form validation from all inputs and returns the boolean result.
			 * 
			 * @return {Boolean} The validation result (true if passed).
			 */
			validate: function() {
				var i;
				var passed = true;
				
				for (i=0; i<this._formFields.length; i++) {
					if (!this._formFields[i].validate()) {
						passed = false;
						break;
					}
				}
				
				return passed;
			}, 
			
			/**
			 * Submits the form to the specified URL and, if successful, executes the callback (optional).
			 * 
			 * If no URL was specified, it will execute the callback with the form data as argument.
			 * 
			 * @return {Boolean} If the form validates and the request successfully started.
			 */
			submit: function() {
				var form = this;
				
				// process all Observer events so we have an up-to-date model
				WebComponents.performMicrotaskCheckpoint();
				
				if (!this.validate()) 
					return false;
				
				var i, j;
				var hasFiles = false;
				
				for (i=0; i<this._formFields.length; i++) {
					// special case: file inputs
					if (this._formFields[i].isFileInput) {
						// check if any files were posted
						var files = this._formFields[i].getFiles();
						for (j=0; j<files.length; j++) {
							hasFiles = true;
						}
					}
				}
				
				// build the body
				var body;
				var url = this._getUrlWithParams(this.url, this.params);
				if (this.method.toUpperCase() == 'GET') {
					url += (url.indexOf('?') > 0 ? '&' : '?') + 
						this.serialize({ asFormData: false });
					body = null;
				} else {
					body = this.serialize({ asFormData: hasFiles });
				}
				
				var event = this.fire('cbn-form-submit', {
					data: this.model, 
					hasFiles: hasFiles
					
				}, null, false, true); // cancelable
				if (event.defaultPrevented) 
					return false;
				
				var xhr = this._buildXHR(
					Polymer.mixin({
						url: url,
						method: this.method
						
					}, this.xhrOptions) );
				
				// bind XHR events
				xhr.onreadystatechange = function() {
					if (xhr.readyState==4) {
						// fire some events!
						if (xhr.status == 200) {
							// success!
							form.fire('cbn-form-ajaxSuccess', {
								xhr: xhr
							}, null, false, false);
						} else {
							// error!
							form.fire('cbn-form-ajaxError', {
								xhr: xhr
							}, null, false, false);
						}
						form.fire('cbn-form-ajaxComplete', {
							xhr: xhr
						}, null, false, false);
					}
				};
				
				xhr.send(body);
				
				return true;
			},
			
			/**
			 * Serializes the form data.
			 * 
			 * @param {Object} serializationOptions If specified, will override the element's serialization options.
			 * @return {String|FormData} The serialized form string / FormData object.
			 */
			serialize: function(serializationOptions) {
				var i, n, f;
				
				if (!serializationOptions) {
					serializationOptions = this.serializationOptions;
					
				} else {
					serializationOptions = Polymer.mixin({ param: 'data' }, 
						this.serializationOptions, serializationOptions);
				}
				
				var fields = []; // array of { key:String, value:String } pairs
				var fileInputs = {}; // the File input objects
				
				var data = null;
				if (serializationOptions.type == 'plain') {
					// flatten the model object
					for (n in this.model) {
						if (this.model.hasOwnProperty(n)) {
							if (serializationOptions.useBrackets && 
									(Object.prototype.toString.call( this.model[n] ) === '[object Array]')) {
								fields.push({ key: n+"[]", value: this.model[n].toString() });
							} else {
								fields.push({ key: n, value: this.model[n].toString() });
							}
						}
					}
					
				} else if (serializationOptions.type == 'json') {
					// send the JSON object as string
					fields.push({ key: serializationOptions.param, value: JSON.stringify(this.model) });
				}
				
				// determine the file inputs
				for (i=0; i<this._formFields.length; i++) {
					f = this._formFields[i];
					if (f.isFileInput) {
						fileInputs[f.name] = f;
					}
				}
				
				if (serializationOptions.asFormData) {
					data = new FormData();
					for (i=0; i<fields.length; i++) {
						data.append(fields[i].key, fields[i].value);
					}
					
					for (f in fileInputs) {
						if (!fileInputs.hasOwnProperty(f))
							continue;
						var files = fileInputs[f].getFiles();
						for (i=0; i<files.length; i++) {
							if (serializationOptions.useBrackets && fileInputs[f].multiple) {
								data.append(f+"[]", files[i]);
							} else {
								data.append(f, files[i]);
							}
						}
					}
				} else {
					data = [];
					for (i=0; i<fields.length; i++) {
						data.push(encodeURIComponent(fields[i].key) + '=' + 
								encodeURIComponent(fields[i].value));
					}
					data = data.join('&');
				}
				
				return data;
			},
			
			
			// Utility methods
			
			/**
			 * Builds a XHR object and returns it. 
			 * 
			 * Similar to `core-xhr`, but with some enhancements and the difference that it doesn't send the request 
			 * automatically after building it.
			 * 
			 * @private
			 * @param {Object} options XHR options object.
			 *    @param {String}  options.url The url to which the request is sent.
			 *    @param {String}  options.method The HTTP method to use (default is GET).
			 *    @param {Boolean} options.sync To send synchronous requests, set to true. Default is false (asynchronous).
			 *    @param {Object}  options.params URL parameters to be sent to the server.
			 *    @param {Object}  options.headers HTTP request headers.
			 *    @param {String}  options.responseType The response type. Default is 'text'.
			 *    @param {Boolean} options.withCredentials Whether or not to send credentials on the request. Default is false.
			 * @return {XMLHttpRequest} The resulting XMLHttpRequest object.
			 */
			_buildXHR: function(options) {
				var xhr = new XMLHttpRequest();
				var url = options.url;
				var method = options.method || 'GET';
				var async = !options.sync;
				
				if (options.params) {
					url = this._getUrlWithParams(url, options.params);
				}
				
				xhr.open(method, url, async);
				
				if (options.responseType) 
					xhr.responseType = options.responseType;
				if (options.withCredentials) 
					xhr.withCredentials = true;
				
				// set headers
				if (options.headers) {
					for (var name in options.headers) {
						if (options.headers.hasOwnProperty(name))
							xhr.setRequestHeader(name, options.headers[name]);
					}
				}
				
				return xhr;
			},
			
			/**
			 * Returns the url with the specified query string parameters appended to it.
			 * Uses the same params format as `core-xhr`.
			 * 
			 * @private
			 * @param {String} url The original URL. Can already contain query string parameters.
			 * @param {Object|String} params The query string parameters to add.
			 * @return {String} The URL with the parameters appended.
			 */
			_getUrlWithParams: function(url, params) {
				if (!this._isEmpty(params)) {
					// serialize the parameters
					var strParams = null;
					if (typeof params == 'object') {
						strParams = this._serializeFormData(params);
					} else {
						strParams = params.toString();
					}
					// append them to the URL
					url += (url.indexOf('?') > 0 ? '&' : '?') + strParams;
				}
				return url;
			}, 
			
			/**
			 * Serializes the specified parameters map using the 'application/x-www-form-urlencoded' (query string) 
			 * format.
			 * 
			 * @private
			 * @param   {Object} params The parameters map to serialize.
			 * @returns {String} The serialized parameters.
			 */
			_serializeFormData: function(params) {
				var r = [];
				for (var n in params) {
					if (params.hasOwnProperty(n)) {
						if (params[n] === true) {
							r.push(params[n] == null ? n : encodeURIComponent(n));
						} else {
							r.push(params[n] == null ? n : (encodeURIComponent(n) +
									'=' + encodeURIComponent(params[n])));
						}
					}
				}
				return r.join('&');
			},

			/**
			 * Checks whether the specified object is empty / false.
			 * 
			 * @param {*} obj The object to check. 
			 * @private
			 */
			_isEmpty: function(obj) {
				if (!obj) return true;
				return Object.getOwnPropertyNames(obj).length == 0;
			}
			
		}, CbnFormModelBindingMixin));
	</script>
	
</polymer-element>
